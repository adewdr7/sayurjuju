<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Produk - Pasar Segar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen pb-24">

    <!-- Navigasi Atas -->
    <nav class="p-4 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
        <div class="flex items-center gap-3">
            <button onclick="window.location.href='index.html'" class="p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800 hover:text-emerald-400 transition-colors">
    <i data-lucide="arrow-left" class="w-6 h-6"></i>
</button>
            <h1 class="text-xl font-bold">Detail Produk</h1>
        </div>
        
        <!-- Ikon Troli (Sama dengan Index) -->
        <a href="index.html?action=checkout" class="p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800 relative hover:text-emerald-400 transition-colors">
    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
    <span id="cart-count-badge" class="absolute -top-1 -right-1 bg-rose-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-950 hidden">0</span>
</a>
    </nav>

    <main id="product-container" class="max-w-2xl mx-auto p-4 space-y-6">
        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-20 gap-4">
            <div class="w-10 h-10 border-4 border-emerald-500/20 border-t-emerald-500 rounded-full animate-spin"></div>
            <p class="text-slate-400">Memuat data produk...</p>
        </div>

        <!-- Product Content (Hidden initially) -->
        <div id="product-content" class="hidden space-y-6">
            <!-- Gambar Produk -->
            <button
  id="pin-btn"
  onclick="togglePinDetail()"
  class="absolute top-4 right-4 p-2 rounded-xl border border-slate-700
         text-slate-400 hover:text-yellow-400 hidden">
  <i data-lucide="pin" class="w-5 h-5"></i>
</button>
                <img id="p-image" src="" alt="Produk" class="w-full h-full object-cover">
                <div id="p-status-tag" class="absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-lg">
                    <!-- Status Segar/Lama -->
                </div>
            </div>

            <!-- Info Produk -->
            <div class="space-y-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="p-name" class="text-2xl font-bold text-white leading-tight"></h2>
                        <p id="p-category" class="text-emerald-400 font-medium"></p>
                    </div>
                    <div class="text-right">
                        <p id="p-price" class="text-2xl font-bold text-emerald-400"></p>
                        <p id="p-unit" class="text-slate-500 text-sm"></p>
                    </div>
                </div>

                <!-- Stok Info -->
                <div class="flex items-center gap-2 p-3 bg-slate-900/50 rounded-2xl border border-slate-800">
                    <i data-lucide="box" class="w-5 h-5 text-slate-400"></i>
                    <span class="text-slate-300">Stok Tersedia:</span>
                    <span id="p-stock" class="font-bold text-white"></span>
                </div>

                <!-- Deskripsi -->
                <div class="space-y-2">
                    <h3 class="font-bold text-white flex items-center gap-2">
                        <i data-lucide="align-left" class="w-4 h-4"></i> Deskripsi Produk
                    </h3>
                    <p id="p-description" class="text-slate-400 leading-relaxed italic">
                        Belum ada deskripsi untuk produk ini.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Action Bar -->
    <div id="action-bar" class="fixed bottom-0 left-0 right-0 p-4 bg-slate-950/80 backdrop-blur-xl border-t border-slate-900 z-50 hidden">
        <div class="max-w-2xl mx-auto flex items-center gap-4">
            <!-- Counter Menu -->
            <div id="counter-group" class="flex items-center bg-slate-900 border border-slate-800 rounded-2xl p-1">
                <button onclick="changeQty(-1)" class="p-2 text-slate-400 hover:text-white disabled:opacity-30" id="btn-minus">
                    <i data-lucide="minus" class="w-5 h-5"></i>
                </button>
                <span id="qty-display" class="w-10 text-center font-bold text-emerald-400">1</span>
                <button onclick="changeQty(1)" class="p-2 text-slate-400 hover:text-white disabled:opacity-30" id="btn-plus">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Tombol Utama -->
            <button id="btn-main-action" class="flex-1 py-4 rounded-2xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/10">
                <!-- Text Button -->
            </button>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  deleteDoc,
  increment,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { mediaDetail } from "./media.js"; // <--- Tambahkan baris ini

        const firebaseConfig = {
  apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
  authDomain: "sayurjuju-bfe82.firebaseapp.com",
  projectId: "sayurjuju-bfe82",
  storageBucket: "sayurjuju-bfe82.firebasestorage.app",
  messagingSenderId: "754413439458",
  appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
};

const appId = firebaseConfig.appId;
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const params = new URLSearchParams(window.location.search);

        let currentProduct = null;
        let selectedQty = 1;
let isPinnedByUser = false;
        const CART_KEY = "pasar_cart";
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];

        

        onAuthStateChanged(auth, (user) => {
  if (!user) {
    // biarkan user guest hanya READ
    loadProduct();
    return;
  }

  loadProduct();
});


        // Load Product Data
        async function loadProduct() {
            const productId = params.get('id');

            if (!productId) {
                document.getElementById('product-container').innerHTML = `<div class="text-center py-20 text-slate-500">Produk tidak ditemukan</div>`;
                return;
            }

            try {
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);
if (docSnap.exists()) {
  currentProduct = { id: docSnap.id, ...docSnap.data() };
  await checkPinStatus();
  renderProduct();
} else {
                    document.getElementById('product-container').innerHTML = `<div class="text-center py-20 text-slate-500">Produk telah dihapus</div>`;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('product-container').innerHTML = `<div class="text-center py-20 text-red-400">Gagal memuat data</div>`;
            }
        }

async function checkPinStatus() {
  const user = auth.currentUser;
  if (!user || !currentProduct) return;

  const pinId = `${currentProduct.id}_${user.uid}`;
  const pinRef = doc(db, "productPins", pinId);

  const snap = await getDoc(pinRef);
  isPinnedByUser = snap.exists();
}

        function renderProduct() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('product-content').classList.remove('hidden');
            document.getElementById('action-bar').classList.remove('hidden');

            const p = currentProduct;
            
            // Image & Status dengan Optimasi media.js
document.getElementById('p-image').src = mediaDetail(p.image) || 'https://images.unsplash.com/photo-1542831371-29b0f74f9713?w=500';
            const statusTag = document.getElementById('p-status-tag');
            let statusText = p.status || "Segar";
let statusClass = "bg-slate-600 text-white";

switch (statusText) {
  case "Sangat Segar":
    statusClass = "bg-emerald-500 text-white";
    break;
  case "Segar":
    statusClass = "bg-green-500 text-white";
    break;
  case "Terbatas":
    statusClass = "bg-amber-500 text-white";
    break;
  case "Habis":
    statusClass = "bg-rose-500 text-white";
    break;
  default:
    statusText = "Lama";
    statusClass = "bg-orange-500 text-white";
}

statusTag.innerText = statusText;
statusTag.className = `
  absolute top-4 left-4 px-3 py-1 rounded-full
  text-[10px] font-bold uppercase tracking-widest shadow-lg
  ${statusClass}
`;

            // Basic Info
            document.getElementById('p-name').innerText = p.name;
            document.getElementById('p-category').innerText = p.category;
            document.getElementById('p-price').innerText = `Rp ${p.price.toLocaleString('id-ID')}`;
            document.getElementById('p-unit').innerText = `per ${p.unit}`;
            document.getElementById('p-stock').innerText = `${p.stock} ${p.unit}`;
            
            if (p.description) {
                document.getElementById('p-description').innerText = p.description;
                document.getElementById('p-description').classList.remove('italic', 'text-slate-500');
            }

            // Button Logic
            const mainBtn = document.getElementById('btn-main-action');
            if (p.stock > 0) {
                mainBtn.innerHTML = `<i data-lucide="shopping-cart" class="w-5 h-5"></i> Tambah ke Keranjang`;
                mainBtn.className = "flex-1 py-4 rounded-2xl font-bold bg-emerald-500 text-white hover:bg-emerald-600 transition-all flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/20";
                mainBtn.onclick = addToCart;
                selectedQty = 1;
                updateQtyUI();
            } else {
                mainBtn.innerHTML = `<i data-lucide="calendar-clock" class="w-5 h-5"></i> Pre-Order Sekarang`;
                mainBtn.className = "flex-1 py-4 rounded-2xl font-bold bg-blue-600 text-white hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20";
                mainBtn.onclick = () => window.location.href = `preorder.html?id=${p.id}`;
                document.getElementById('counter-group').classList.add('hidden');
            }
const pinBtn = document.getElementById("pin-btn");
const user = auth.currentUser;

if (user) {
  pinBtn.classList.remove("hidden");

  pinBtn.className = `
    absolute top-4 right-4 p-2 rounded-xl border
    ${isPinnedByUser
      ? "text-yellow-400 border-yellow-400"
      : "text-slate-400 border-slate-700 hover:text-yellow-400"}
  `;
} else {
  pinBtn.classList.add("hidden");
}
            
            lucide.createIcons();
        }

window.togglePinDetail = async () => {
  const user = auth.currentUser;
  if (!user) {
    alert("Login dulu untuk pin produk");
    return;
  }

  const pinId = `${currentProduct.id}_${user.uid}`;
  const pinRef = doc(db, "productPins", pinId);
  const productRef = doc(db, "products", currentProduct.id);

  if (isPinnedByUser) {
    // UNPIN
    await deleteDoc(pinRef);
    await setDoc(productRef, {
      pinCount: increment(-1)
    }, { merge: true });

    isPinnedByUser = false;
  } else {
    // PIN
    await setDoc(pinRef, {
      productId: currentProduct.id,
      userId: user.uid,
      createdAt: serverTimestamp()
    });

    await setDoc(productRef, {
      pinCount: increment(1)
    }, { merge: true });

    isPinnedByUser = true;
  }

  renderProduct(); // refresh UI
};

        // Counter Logic
        window.changeQty = (val) => {
            if (!currentProduct) return;
            const newQty = selectedQty + val;
            if (newQty >= 1 && newQty <= currentProduct.stock) {
                selectedQty = newQty;
                updateQtyUI();
            }
        };

        function updateQtyUI() {
            document.getElementById('qty-display').innerText = selectedQty;
            document.getElementById('btn-minus').disabled = selectedQty <= 1;
            document.getElementById('btn-plus').disabled = selectedQty >= currentProduct.stock;
        }

function syncCart() {
    cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
}

        // Cart Logic
        function addToCart() {
            const existingIndex = cart.findIndex(item => item.id === currentProduct.id);
            
            if (existingIndex > -1) {
                // Update produk yang sama
                const newTotalQty = cart[existingIndex].qty + selectedQty;
                if (newTotalQty > currentProduct.stock) {
                    cart[existingIndex].qty = currentProduct.stock;
                    alert("Jumlah disesuaikan dengan stok maksimal");
                } else {
                    cart[existingIndex].qty = newTotalQty;
                }
                        } else {
                // Tambah baru
                cart.push({
                    id: currentProduct.id,
                    name: currentProduct.name,
                    price: currentProduct.price,
                    image: currentProduct.image,
                    qty: selectedQty,
                    unit: currentProduct.unit,
                    stock: currentProduct.stock // PENTING: Tambahkan ini agar index.html tahu batas maksimal
                });
            }


            saveCart();
            updateCartBadge();
            
            // Feedback visual
            const btn = document.getElementById('btn-main-action');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> Berhasil Ditambah!`;
            btn.classList.replace('bg-emerald-500', 'bg-slate-700');
            
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.replace('bg-slate-700', 'bg-emerald-500');
                lucide.createIcons();
            }, 2000);
            
            lucide.createIcons();
        }

        function saveCart() {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
}

        function updateCartBadge() {
            const badge = document.getElementById('cart-count-badge');
            const count = cart.reduce((total, item) => total + item.qty, 0);
            
            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Sync with index.html open cart request
        if (params.get('added') === 'true') {
            updateCartBadge();
        }
    </script>
</body>
</html>









