<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasar Segar - Katalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <div id="app">
        <nav class="p-4 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
            <div class="flex items-center gap-3">
                <!-- Tombol Kelola Produk: Hanya untuk Admin -->
                <a href="kelola.html" id="btn-manage" class="hidden p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800 hover:text-emerald-400 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </a>
                <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Pasar Segar</h1>
            </div>
            <div class="flex items-center gap-2">
                <a href="tambahproduk.html" id="btn-admin" class="hidden p-2 bg-emerald-500/10 text-emerald-400 rounded-xl border border-emerald-500/20">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i>
                </a>
                <a href="login.html" id="btn-login-nav" class="p-2 bg-slate-900 rounded-xl border border-slate-800 text-slate-400">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
                <button id="btn-cart-toggle" onclick="toggleCart()" class="relative p-2 bg-slate-900 rounded-xl border border-slate-800">
    </button>
            </div>
        </nav>
<!-- STATUS DAGANG HARI INI -->
<div class="px-4 mt-4">
  <div id="daily-status"
       class="flex items-center justify-between gap-3 p-4 rounded-2xl border border-slate-800 bg-slate-900">
       
    <div>
      <p class="text-xs text-slate-400">Status Dagang Hari Ini</p>
      <p id="status-text" class="font-bold text-sm text-slate-200">
        Memuat status...
      </p>
      <p id="status-note" class="text-xs text-slate-500"></p>
<input id="admin-status-note"
  type="text"
  placeholder="Catatan (admin)"
  class="hidden mt-2 w-full text-xs px-3 py-2 rounded-xl
         bg-slate-800 text-slate-200 border border-slate-700" />
    </div>

    <!-- Tombol hanya muncul untuk ADMIN -->
    <select id="admin-status-select"
        class="hidden text-xs px-3 py-2 rounded-xl bg-slate-800 text-slate-200 border border-slate-700">
  <option value="BERJUALAN">üü¢ BERJUALAN</option>
  <option value="DI PASAR">üß∫ DI PASAR</option>
  <option value="LIBUR">üî¥ LIBUR</option>
  <option value="SELESAI">‚èπ SELESAI</option>
</select>
  </div>
</div>

<div class="px-4 mt-3">
  <a href="preorder.html"
   id="btn-preorder"
   onclick="window.location.href='preorder.html'"
   class="relative pointer-events-auto z-40
          w-full flex items-center justify-center gap-2
          text-sm font-semibold
          bg-cyan-600/10 border border-cyan-500/30
          text-cyan-400 rounded-xl
          py-3
          hover:bg-cyan-600/20 transition">

  üì¶ Pre Order

  <!-- BADGE PREORDER (ADMIN) -->
  <span id="preorder-badge"
        class="hidden absolute -top-2 -right-2
               bg-yellow-400 text-black
               text-[10px] font-bold
               w-5 h-5 rounded-full
               flex items-center justify-center">
    0
  </span>
</a>
</div>

        <!-- SEARCH + FILTER (STICKY, SATU BLOK) -->
<div class="sticky top-[72px] z-30 bg-slate-950/95 backdrop-blur-md pointer-events-none">

  <!-- SEARCH -->
  <div class="px-4 pt-4 pointer-events-auto">
    <div class="relative">
      <i data-lucide="search"
         class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>

      <input
        type="text"
        id="search-input"
        oninput="renderProducts()"
        placeholder="Cari bumbu, sayur..."
        class="w-full bg-slate-900 border border-slate-800 rounded-xl
               py-3 pl-10 pr-4 text-sm
               focus:ring-2 focus:ring-emerald-500 outline-none">
    </div>
  </div>

  <!-- FILTER -->
  <div
  id="category-list"
  class="flex gap-2 overflow-x-auto px-4 py-3 hide-scrollbar pointer-events-auto">
</div>

</div>
<!-- PRODUCT GRID -->
<div class="px-4 grid grid-cols-2 gap-4 pb-24 mt-4" id="product-grid">
  <div class="col-span-2 text-center py-10 text-slate-500">
    Memuat produk...
  </div>
</div>

        <!-- Modal Keranjang -->
        <div id="cart-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleCart()"></div>
            <div class="absolute inset-y-0 right-0 w-full max-w-sm bg-slate-900 flex flex-col shadow-2xl border-l border-slate-800">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h2 class="font-bold flex items-center gap-2"><i data-lucide="shopping-cart"></i> Keranjang</h2>
                    <button onclick="toggleCart()" class="p-2"><i data-lucide="x"></i></button>
                </div>
                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
               <div class="p-4 border-t border-slate-800 bg-slate-900/50">

    <!-- METODE PENGAMBILAN -->
    <div class="space-y-3 mb-4">
        <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-xl cursor-pointer">
            <input type="radio" name="delivery" value="ANTAR" checked>
            <span class="text-sm">üõµ Antarkan (Ongkir)</span>
        </label>

        <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-xl cursor-pointer">
            <input type="radio" name="delivery" value="AMBIL">
            <span class="text-sm">üö∂ Ambil pas Mama saya keliling</span>
        </label>
    </div>

    <div class="space-y-1 mb-4">
  <div class="flex justify-between text-sm">
    <span class="text-slate-400">Ongkir:</span>
    <span id="cart-shipping">Rp 0</span>
  </div>

  <div class="flex justify-between text-sm">
    <span class="text-slate-400">Subtotal:</span>
    <span id="cart-subtotal">Rp 0</span>
  </div>

  <div class="flex justify-between">
    <span class="text-slate-400">Total:</span>
    <span id="cart-total" class="font-bold text-emerald-400 text-xl">Rp 0</span>
  </div>
</div>

    <!-- CHECKOUT -->
    <button onclick="checkout()" 
        class="w-full bg-emerald-500 py-4 rounded-xl font-bold">
        Checkout
    </button>
</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import {
  getFirestore, collection, onSnapshot, query, orderBy,
  addDoc, doc, updateDoc, increment, serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { mediaGrid, mediaThumb } from "./media.js"; // <--- Tambahkan ini

        const firebaseConfig = {
            apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
            authDomain: "sayurjuju-bfe82.firebaseapp.com",
            projectId: "sayurjuju-bfe82",
            storageBucket: "sayurjuju-bfe82.firebasestorage.app",
            messagingSenderId: "754413439458",
            appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

let shippingFee = 0;
const shippingRef = doc(db, "settings", "shipping");

onSnapshot(shippingRef, (snap) => {
  if (snap.exists()) {
    shippingFee = snap.data().fee ?? 0;
    updateCartUI(); // refresh total realtime
  }
});

// ===============================
// ADMIN: NOTIFIKASI PREORDER
// ===============================
function listenPreorderNotification() {
    const badge = document.getElementById("preorder-badge");
    if (!badge) return;

    const q = query(
        collection(db, "preorders"),
        orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
        let count = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === "PENDING") {
                count++;
            }
        });

        badge.innerText = count;
        badge.classList.toggle("hidden", count === 0);
    });
}

// ===============================
// ADMIN: NOTIFIKASI PESANAN BARU
// ===============================
function listenOrderNotification() {
    const badge = document.getElementById("order-badge");
    if (!badge) return;

    const q = query(
        collection(db, "orders"),
        orderBy("createdAtClient", "desc")
    );

    onSnapshot(q, (snapshot) => {
        let count = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === "MENUNGGU") {
                count++;
            }
        });

        badge.innerText = count;
        badge.classList.toggle("hidden", count === 0);
    });
}

        const productsRef = collection(db, "products");
const statusRef = doc(db, "settings", "dailyStatus");

        let allProducts = [];
        const CART_KEY = "pasar_cart";
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
        let currentCategory = "Semua";

        const ADMIN_UID = "XVmdoXxSptTlA8xHVmAIzeLgkru2";

       onAuthStateChanged(auth, (user) => {
cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    updateCartUI();
    const adminBtn = document.getElementById("btn-admin");
    const manageBtn = document.getElementById("btn-manage");
    const loginBtn = document.getElementById("btn-login-nav");
    const cartBtn = document.getElementById("btn-cart-toggle"); // Ambil elemen tombol
    
    if (user) {
        if (user.uid === ADMIN_UID) {

document.getElementById("admin-status-select").classList.remove("hidden");
document.getElementById("admin-status-note").classList.remove("hidden");

            // Tampilan JIKA ADMIN
            adminBtn.classList.remove("hidden");
            manageBtn.classList.remove("hidden");
            
            // UBAH TOMBOL KERANJANG JADI KELOLA PESANAN
           cartBtn.innerHTML = `
    <i data-lucide="clipboard-list" class="w-6 h-6 text-cyan-400"></i>

    <!-- BADGE NOTIF ORDER -->
    <span id="order-badge"
    class="hidden absolute -top-1 -right-1
           bg-blue-500 text-white text-[10px]
           font-bold w-5 h-5 rounded-full
           flex items-center justify-center">
    0
</span>

    <span class="sr-only">Pesanan</span>
`;
            
            // Alihkan fungsi klik jika admin ingin langsung ke halaman orders
            cartBtn.onclick = () => window.location.href = "orders.html";
listenOrderNotification();
listenPreorderNotification();
        } else {
document.getElementById("admin-status-select").classList.add("hidden");
document.getElementById("admin-status-note").classList.add("hidden");
            // Tampilan JIKA PELANGGAN BIASA
            setDefaultCartBtn(cartBtn);
        }
        
        loginBtn.innerHTML = '<i data-lucide="user-check" class="w-6 h-6 text-emerald-400"></i>';
        loginBtn.href = "profile.html";
    } else {
        // Tampilan JIKA BELUM LOGIN
        adminBtn.classList.add("hidden");
        manageBtn.classList.add("hidden");
        setDefaultCartBtn(cartBtn);
        
        loginBtn.innerHTML = '<i data-lucide="user" class="w-6 h-6"></i>';
        loginBtn.href = "login.html";
    }
    lucide.createIcons();
});

// üîì AUTO BUKA CART DARI product.html
const params = new URLSearchParams(window.location.search);
if (params.get("openCart") === "true") {
    toggleCart();
}

// ===============================
// ADMIN: DROPDOWN UBAH STATUS
// ===============================
const statusSelect = document.getElementById("admin-status-select");

if (statusSelect) {
  statusSelect.onchange = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== ADMIN_UID) return;

    await updateDoc(statusRef, {
      status: statusSelect.value,
      updatedAt: serverTimestamp()
    });
  };
}

// ===============================
// ADMIN: UPDATE CATATAN STATUS
// ===============================
const noteInput = document.getElementById("admin-status-note");

if (noteInput) {
  noteInput.onchange = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== ADMIN_UID) return;

    await updateDoc(statusRef, {
      note: noteInput.value,
      updatedAt: serverTimestamp()
    });
  };
}

// ===============================
// STATUS DAGANG HARI INI
// ===============================
onSnapshot(statusRef, (snap) => {
  if (!snap.exists()) return;

  const data = snap.data();
const select = document.getElementById("admin-status-select");
if (select && !select.classList.contains("hidden")) {
  select.value = data.status;
}
  const statusText = document.getElementById("status-text");
  const statusNote = document.getElementById("status-note");

  let icon = "üü¢";
  let color = "text-emerald-400";

  if (data.status === "LIBUR") {
    icon = "üî¥";
    color = "text-rose-400";
  } else if (data.status === "DI PASAR") {
    icon = "üß∫";
    color = "text-amber-400";
  } else if (data.status === "SELESAI") {
    icon = "‚èπ";
    color = "text-slate-400";
  }

  statusText.innerHTML = `<span class="${color}">${icon} ${data.status}</span>`;
  statusNote.innerText = data.note || "";
const noteInput = document.getElementById("admin-status-note");
if (noteInput && !noteInput.classList.contains("hidden")) {
  noteInput.value = data.note || "";
}
});

// Fungsi pembantu untuk mengembalikan tampilan Keranjang Belanja
function setDefaultCartBtn(btn) {
    btn.innerHTML = `
        <i data-lucide="shopping-cart" class="w-6 h-6 text-emerald-400"></i>
        <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-rose-500 text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
    `;
    btn.onclick = () => toggleCart();
}

        // Load Products
        onSnapshot(query(productsRef, orderBy("name", "asc")), (snapshot) => {
            allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCategories();
            renderProducts();
        });

        window.renderCategories = () => {
            const categories = ["Semua", "Sayur Mentah", "Buah", "Bumbu Dapur", "Ikan", "Daging", "Makanan", "Pangan", "Lainnya"];
            const list = document.getElementById('category-list');
            list.innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat}')" 
                    class="px-4 py-2 rounded-full whitespace-nowrap text-xs font-semibold transition-all ${currentCategory === cat ? 'bg-emerald-500 text-white' : 'bg-slate-900 text-slate-400 border border-slate-800'}">
                    ${cat}
                </button>
            `).join('');
        };

        window.setCategory = (cat) => {
            currentCategory = cat;
            renderCategories();
            renderProducts();
        };

        window.renderProducts = () => {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const grid = document.getElementById('product-grid');
    const filtered = allProducts.filter(p => (currentCategory === "Semua" || p.category === currentCategory) && p.name.toLowerCase().includes(searchTerm));

    if (filtered.length === 0) {
        grid.innerHTML = '<div class="col-span-2 text-center py-10 text-slate-500">Produk tidak ditemukan</div>';
        return;
    }

    // Ambil UID user saat ini untuk pengecekan admin
    const user = auth.currentUser;

    grid.innerHTML = filtered.map(p => {
        // Tentukan link tujuan berdasarkan status admin
        const targetPage = (user && user.uid === ADMIN_UID) ? 'edit-product.html' : 'product.html';
        
        return `
            <div onclick="location.href='${targetPage}?id=${p.id}'"
                 class="bg-slate-900 rounded-2xl overflow-hidden border border-slate-800 flex flex-col shadow-lg cursor-pointer">
                <div class="relative h-32 bg-slate-800">
                    <img src="${mediaGrid(p.image)}" class="w-full h-full object-cover">
                    <span class="absolute top-2 right-2 px-1.5 py-0.5 rounded text-[8px] font-bold uppercase ${p.status === 'Segar' ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'}">${p.status}</span>
                </div>
                <div class="p-3 flex-1 flex flex-col">
                    <h3 class="font-bold text-sm truncate text-slate-100">${p.name}</h3>
                    <p class="text-[10px] text-slate-500">Stok: ${p.stock} ‚Ä¢ ${p.unit}</p>
                    <div class="mt-auto flex justify-between items-center">
                        <span class="text-emerald-400 font-bold text-xs">Rp ${Number(p.price).toLocaleString()}</span>
                        <button onclick="event.stopPropagation(); addToCart('${p.id}')" 
                                class="${(user && user.uid === ADMIN_UID) ? 'bg-cyan-500' : 'bg-emerald-500'} p-2 rounded-xl text-white">
                            <i data-lucide="${(user && user.uid === ADMIN_UID) ? 'package-plus' : 'plus'}" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    lucide.createIcons();
};

        window.addToCart = async (id) => {
    const user = auth.currentUser;

    // ADMIN ‚Üí tambah stok
    if (user && user.uid === ADMIN_UID) {
        try {
            const productRef = doc(db, "products", id);
            await updateDoc(productRef, {
                stock: increment(1)
            });
        } catch (err) {
            console.error("Gagal update stok:", err);
        }
        return;
    }

    // PELANGGAN ‚Üí tambah ke cart
    const product = allProducts.find(p => p.id === id);
    if (!product || product.stock <= 0) {
        alert("Stok habis!");
        return;
    }

    const existing = cart.find(item => item.id === id);

    if (existing) {
        if (existing.qty >= product.stock) {
            alert("Tidak bisa melebihi stok yang tersedia");
            return;
        }
        existing.qty++;
    } else {
        cart.push({
    id: product.id,
    name: product.name,
    price: product.price,
    image: product.image,
    qty: 1,
    unit: product.unit,
    stock: product.stock
});
    }

    // üîë WAJIB: simpan & update UI
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartUI();
};

function syncCart() {
    cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
}

window.updateCartUI = () => {
cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    // Ambil elemen-elemen yang diperlukan
    const badge = document.getElementById('cart-badge');
    const itemsContainer = document.getElementById('cart-items');
    const totalContainer = document.getElementById('cart-total');

    // Hitung jumlah item di keranjang
    const count = cart.reduce((sum, item) => sum + item.qty, 0);

    // FIX: Cek dulu apakah badge ada sebelum mengisi innerText
    if (badge) {
        badge.innerText = count;
        badge.classList.toggle('hidden', count === 0);
    }

    // Update daftar item di modal keranjang jika elemennya ada
    if (itemsContainer) {
        itemsContainer.innerHTML = cart.map(item => `
            <div class="flex gap-3 bg-slate-800/50 p-3 rounded-2xl border border-slate-800/50">
                <img src="${mediaThumb(item.image)}" class="w-12 h-12 rounded-lg object-cover">
                <div class="flex-1">
                    <h4 class="text-xs font-bold text-slate-100">${item.name}</h4>
                    <p class="text-[10px] text-emerald-400">${item.qty} x Rp ${Number(item.price).toLocaleString()}</p>
                </div>
                <button onclick="removeFromCart('${item.id}')" class="text-rose-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
        `).join('');
    }

    // Update total harga jika elemennya ada
    if (totalContainer) {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

const method = document.querySelector('input[name="delivery"]:checked')?.value;
const ongkir = method === "ANTAR" ? shippingFee : 0;

document.getElementById("cart-subtotal").innerText =
  `Rp ${subtotal.toLocaleString()}`;

document.getElementById("cart-shipping").innerText =
  ongkir === 0 ? "Gratis" : `Rp ${ongkir.toLocaleString()}`;

totalContainer.innerText =
  `Rp ${(subtotal + ongkir).toLocaleString()}`;
    }

    lucide.createIcons();
};

        window.toggleCart = () => document.getElementById('cart-modal').classList.toggle('hidden');
        window.removeFromCart = (id) => { cart = cart.filter(i => i.id !== id);
localStorage.setItem(CART_KEY, JSON.stringify(cart));
updateCartUI(); };
        window.checkout = async function () {
    const user = auth.currentUser;
    if (!user) { alert("Silakan login dulu"); return; }
    if (cart.length === 0) { alert("Keranjang kosong"); return; }

    const method = document.querySelector('input[name="delivery"]:checked').value;
    const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
    const shipping = method === "ANTAR" ? shippingFee : 0;
const total = subtotal + shipping;

    try {
        await addDoc(collection(db, "orders"), {
            userId: user.uid,
            userName: document.getElementById('user-name')?.innerText || user.email, // Tambahkan ini agar admin tahu siapa yang pesan
            items: cart.map(i => ({
                productId: i.id,
                name: i.name,
                qty: i.qty,
                price: i.price
            })),
            total,
            deliveryMethod: method,
            status: "MENUNGGU",
            createdAt: serverTimestamp(),          // untuk server (valid jangka panjang)
createdAtClient: Number(Date.now()),          // üî• untuk UI & sorting langsung
cancelableUntil: Date.now() + (5 * 60 * 1000)
        });

        // HAPUS LOGIKA PENGURANGAN STOK DI SINI
        cart = [];
localStorage.removeItem(CART_KEY); // üî• INI KUNCI UTAMA
updateCartUI();
toggleCart();
alert("Pesanan berhasil dibuat üéâ");
window.location.href = "profile.html";
    } catch (err) { alert("Gagal checkout: " + err.message); }
};

        lucide.createIcons();

window.addEventListener('focus', () => {
    cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    if (typeof updateCartUI === 'function') {
        updateCartUI();
    }
});

window.addEventListener('load', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('action') === 'checkout') {
            const cartModal = document.getElementById('cart-modal');
            if (cartModal) {
                // Beri sedikit jeda agar data keranjang siap
                setTimeout(() => {
                    cartModal.classList.remove('hidden');
                    if (typeof window.updateCartUI === 'function') {
                        window.updateCartUI();
                    }
                }, 300); 
            }
        }
    });
    </script>
</body>
</html>
















