<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasar Segar - Katalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100">

    <div id="app">
        <nav class="p-4 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
            <div class="flex items-center gap-3">
                <!-- Tombol Kelola Produk: Hanya untuk Admin -->
                <a href="kelola.html" id="btn-manage" class="hidden p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800 hover:text-emerald-400 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </a>
                <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Pasar Segar</h1>
            </div>
            <div class="flex items-center gap-2">
                <a href="tambahproduk.html" id="btn-admin" class="hidden p-2 bg-emerald-500/10 text-emerald-400 rounded-xl border border-emerald-500/20">
                    <i data-lucide="plus-circle" class="w-6 h-6"></i>
                </a>
                <a href="login.html" id="btn-login-nav" class="p-2 bg-slate-900 rounded-xl border border-slate-800 text-slate-400">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
               <button id="btn-cart-toggle" onclick="toggleCart()" class="relative p-2 bg-slate-900 rounded-xl border border-slate-800">
  <i data-lucide="shopping-cart" class="w-6 h-6 text-emerald-400"></i>
  <span id="cart-badge"
    class="hidden absolute -top-1 -right-1
           bg-rose-500 text-[10px] font-bold
           w-5 h-5 rounded-full
           flex items-center justify-center">
    0
  </span>
</button>
            </div>
        </nav>
<!-- STATUS DAGANG HARI INI -->
<div class="px-4 mt-4">
  <div id="daily-status"
       class="flex items-center justify-between gap-3 p-4 rounded-2xl border border-slate-800 bg-slate-900">
       
    <div>
      <p class="text-xs text-slate-400">Status Dagang Hari Ini</p>
      <p id="status-text" class="font-bold text-sm text-slate-200">
        Memuat status...
      </p>
      <p id="status-note" class="text-xs text-slate-500"></p>
<input id="admin-status-note"
  type="text"
  placeholder="Catatan (admin)"
  class="hidden mt-2 w-full text-xs px-3 py-2 rounded-xl
         bg-slate-800 text-slate-200 border border-slate-700" />
    </div>

    <!-- Tombol hanya muncul untuk ADMIN -->
    <select id="admin-status-select"
        class="hidden text-xs px-3 py-2 rounded-xl bg-slate-800 text-slate-200 border border-slate-700">
  <option value="BERJUALAN">üü¢ BERJUALAN</option>
  <option value="DI PASAR">üß∫ DI PASAR</option>
  <option value="LIBUR">üî¥ LIBUR</option>
  <option value="SELESAI">‚èπ SELESAI</option>
</select>
  </div>
</div>

<div class="px-4 mt-3">
  <a href="preorder.html"
   id="btn-preorder"
   onclick="window.location.href='preorder.html'"
   class="relative pointer-events-auto z-40
          w-full flex items-center justify-center gap-2
          text-sm font-semibold
          bg-cyan-600/10 border border-cyan-500/30
          text-cyan-400 rounded-xl
          py-3
          hover:bg-cyan-600/20 transition">

  üì¶ Pre Order

  <!-- BADGE PREORDER (ADMIN) -->
  <span id="preorder-badge"
        class="hidden absolute -top-2 -right-2
               bg-yellow-400 text-black
               text-[10px] font-bold
               w-5 h-5 rounded-full
               flex items-center justify-center">
    0
  </span>
</a>
</div>

        <!-- SEARCH + FILTER (STICKY, SATU BLOK) -->
<div class="sticky top-[72px] z-30 bg-slate-950/95 backdrop-blur-md pointer-events-none">

  <!-- SEARCH -->
  <div class="px-4 pt-4 pointer-events-auto">
    <div class="relative">
  <i data-lucide="search"
     class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i>

  <input
    type="text"
    id="search-input"
    oninput="handleSearchInput()"
    placeholder="Cari bumbu, sayur..."
    class="w-full bg-slate-900 border border-slate-800 rounded-xl
           py-3 pl-10 pr-10 text-sm
           focus:ring-2 focus:ring-emerald-500 outline-none">

  <button 
    id="clear-search"
    onclick="clearSearch()"
    class="hidden absolute right-3 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white">
    <i data-lucide="x" class="w-4 h-4"></i>
  </button>
</div>
  </div>

  <!-- FILTER -->
  <div
  id="category-list"
  class="flex gap-2 overflow-x-auto px-4 py-3 hide-scrollbar pointer-events-auto">
</div>

</div>
<!-- PRODUCT GRID -->
<div class="px-4 grid grid-cols-2 gap-4 pb-24 mt-4" id="product-grid">
  <div class="col-span-2 text-center py-10 text-slate-500">
    Memuat produk...
  </div>
</div>

        <!-- Modal Keranjang -->
        <div id="cart-modal" class="fixed inset-0 z-50 hidden">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="toggleCart()"></div>
            <div class="absolute inset-y-0 right-0 w-full max-w-sm bg-slate-900 flex flex-col shadow-2xl border-l border-slate-800">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h2 class="font-bold flex items-center gap-2"><i data-lucide="shopping-cart"></i> Keranjang</h2>
                    <button onclick="toggleCart()" class="p-2"><i data-lucide="x"></i></button>
                </div>
                <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
               <div class="p-4 border-t border-slate-800 bg-slate-900/50">

    <!-- METODE PENGAMBILAN -->
    <div class="space-y-3 mb-4">
        <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-xl cursor-pointer">
            <input type="radio" name="delivery" value="ANTAR" checked>
            <span class="text-sm">üõµ Antarkan (Ongkir)</span>
        </label>

        <label class="flex items-center gap-3 p-3 bg-slate-800 rounded-xl cursor-pointer">
            <input type="radio" name="delivery" value="AMBIL">
            <span class="text-sm">üö∂ Ambil pas Mama saya keliling</span>
        </label>
    </div>

    <div class="space-y-1 mb-4">
  <div class="flex justify-between text-sm">
    <span class="text-slate-400">Ongkir:</span>
    <span id="cart-shipping">Rp 0</span>
  </div>

  <div class="flex justify-between text-sm">
    <span class="text-slate-400">Subtotal:</span>
    <span id="cart-subtotal">Rp 0</span>
  </div>

  <div class="flex justify-between">
    <span class="text-slate-400">Total:</span>
    <span id="cart-total" class="font-bold text-emerald-400 text-xl">Rp 0</span>
  </div>
</div>

    <!-- CHECKOUT -->
    <button onclick="checkout()" 
        class="w-full bg-emerald-500 py-4 rounded-xl font-bold">
        Checkout
    </button>
</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import {
  getFirestore, collection, onSnapshot, query, orderBy, limit, addDoc, doc, updateDoc, increment, serverTimestamp, deleteDoc, getDoc, setDoc, where, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
import { mediaGrid, mediaThumb } from "./media.js"; // <--- Tambahkan ini

        const firebaseConfig = {
            apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
            authDomain: "sayurjuju-bfe82.firebaseapp.com",
            projectId: "sayurjuju-bfe82",
            storageBucket: "sayurjuju-bfe82.firebasestorage.app",
            messagingSenderId: "754413439458",
            appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
// üîî Tracking order untuk notifikasi admin
let lastPendingOrderCount = 0;
let orderListenerInitialized = false;
let hasInitialSnapshot = false;

let shippingFee = 0;
const shippingRef = doc(db, "settings", "shipping");

onSnapshot(shippingRef, (snap) => {
  if (snap.exists()) {
    shippingFee = snap.data().fee ?? 0;
    updateCartUI(); // refresh total realtime
  }
});

function sendAndroidNotif(type, title, body) {
  if (window.Android && typeof Android.notify === "function") {
    Android.notify(type, title, body);
  }
}

// ===============================
// ADMIN: NOTIFIKASI PREORDER
// ===============================
function listenPreorderNotification() {
    const badge = document.getElementById("preorder-badge");
    if (!badge) return;

    const q = query(
        collection(db, "preorders"),
        orderBy("createdAt", "desc")
    );

    let initialized = false;
    let lastPending = 0;

    onSnapshot(q, (snapshot) => {
        let pendingCount = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === "PENDING") {
                pendingCount++;
            }
        });

        // üîî Notif hanya jika preorder BARU
        if (
            initialized &&
            pendingCount > lastPending &&
            window.Android &&
            !window.location.pathname.includes("preorder.html")
        ) {
            Android.notify(
                "preorder",
                "Pre Order Masuk",
                "Ada preorder baru dari pelanggan"
            );
        }

        initialized = true;
        lastPending = pendingCount;

        badge.innerText = pendingCount;
        badge.classList.toggle("hidden", pendingCount === 0);
    });
}

function listenOrderNotification() {
    const badge = document.getElementById("order-badge");
    if (!badge || orderListenerInitialized) return;

    orderListenerInitialized = true;

    const q = query(
        collection(db, "orders"),
        orderBy("createdAt", "desc")
    );

    onSnapshot(q, (snapshot) => {
    let pendingCount = 0;

    snapshot.forEach(doc => {
        const data = doc.data();
        if (data.status === "MENUNGGU") {
            pendingCount++;
        }
    });

    // üîî Bunyi HANYA setelah snapshot pertama lewat
    if (hasInitialSnapshot && pendingCount > lastPendingOrderCount) {
        if (window.Android && !window.location.pathname.includes("orders.html")) {
            Android.notify(
                "order",
                "Pesanan Baru",
                "Ada pesanan masuk"
            );
        }
    }

    // ‚õ≥ Tandai bahwa snapshot pertama sudah lewat
    hasInitialSnapshot = true;

    // Simpan jumlah terakhir
    lastPendingOrderCount = pendingCount;

    badge.innerText = pendingCount;
    badge.classList.toggle("hidden", pendingCount === 0);
});
}

function listenCancelNotification() {
  const q = query(collection(db, "orders"));

  let initialized = false;
  let notified = new Set();

  onSnapshot(q, (snapshot) => {
    snapshot.docChanges().forEach(change => {
      const data = change.doc.data();

      if (
        initialized &&
        change.type === "modified" &&
        data.status === "DIBATALKAN" &&
        !notified.has(change.doc.id)
      ) {
        notified.add(change.doc.id);

        if (window.Android) {
          Android.notify(
            "cancel",
            "Pesanan Dibatalkan",
            "Ada pesanan yang dibatalkan customer"
          );
        }
      }
    });

    initialized = true;
  });
}

        const productsRef = collection(db, "products");

let isFirstLoad = true;

const q = query(
  productsRef,
  orderBy("createdAt", "desc"),
  limit(1)
);

onSnapshot(q, (snapshot) => {
  if (snapshot.empty) return;

  // ‚õî Supaya tidak bunyi saat pertama kali buka app
  if (isFirstLoad) {
    isFirstLoad = false;
    return;
  }

  snapshot.docChanges().forEach((change) => {
    if (change.type === "added") {
      const product = change.doc.data();

      sendAndroidNotif(
        "newproduk",
        "Produk Baru Tersedia ü•¨",
        product.name + " sudah tersedia di Pasar Segar"
      );
    }
  });
});

const statusRef = doc(db, "settings", "dailyStatus");

        let allProducts = [];
        const CART_KEY = "pasar_cart";
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
        let currentCategory = "Semua";
let userPinnedProducts = new Set();

        const ADMIN_UID = "XVmdoXxSptTlA8xHVmAIzeLgkru2";

       onAuthStateChanged(auth, (user) => {
cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    updateCartUI();
    const adminBtn = document.getElementById("btn-admin");
    const manageBtn = document.getElementById("btn-manage");
    const loginBtn = document.getElementById("btn-login-nav");
    const cartBtn = document.getElementById("btn-cart-toggle"); // Ambil elemen tombol
    
    if (user) {
const q = query(
      collection(db, "productPins"),
      where("userId", "==", user.uid)
    );

    onSnapshot(q, (snap) => {
      userPinnedProducts.clear();
      snap.forEach(d => {
        userPinnedProducts.add(d.data().productId);
      });
      renderProducts();
    });
 
        if (user.uid === ADMIN_UID) {

document.getElementById("admin-status-select").classList.remove("hidden");
document.getElementById("admin-status-note").classList.remove("hidden");

            // Tampilan JIKA ADMIN
            adminBtn.classList.remove("hidden");
            manageBtn.classList.remove("hidden");
            
            // UBAH TOMBOL KERANJANG JADI KELOLA PESANAN
           cartBtn.innerHTML = `
    <i data-lucide="clipboard-list" class="w-6 h-6 text-cyan-400"></i>

    <!-- BADGE NOTIF ORDER -->
    <span id="order-badge"
    class="hidden absolute -top-1 -right-1
           bg-blue-500 text-white text-[10px]
           font-bold w-5 h-5 rounded-full
           flex items-center justify-center">
    0
</span>

    <span class="sr-only">Pesanan</span>
`;
            
            // Alihkan fungsi klik jika admin ingin langsung ke halaman orders
            cartBtn.onclick = () => window.location.href = "orders.html";
listenOrderNotification();
listenPreorderNotification();
listenCancelNotification();
        } else {
document.getElementById("admin-status-select").classList.add("hidden");
document.getElementById("admin-status-note").classList.add("hidden");
            // Tampilan JIKA PELANGGAN BIASA
            setDefaultCartBtn(cartBtn);
        }
        
        loginBtn.innerHTML = '<i data-lucide="user-check" class="w-6 h-6 text-emerald-400"></i>';
        loginBtn.href = "profile.html";
    } else {
        // Tampilan JIKA BELUM LOGIN
userPinnedProducts.clear();
        adminBtn.classList.add("hidden");
        manageBtn.classList.add("hidden");
        setDefaultCartBtn(cartBtn);
        
        loginBtn.innerHTML = '<i data-lucide="user" class="w-6 h-6"></i>';
        loginBtn.href = "login.html";
    }
    lucide.createIcons();
});

// üîì AUTO BUKA CART DARI product.html
const params = new URLSearchParams(window.location.search);
if (params.get("openCart") === "true") {
    toggleCart();
}

// ===============================
// ADMIN: DROPDOWN UBAH STATUS
// ===============================
const statusSelect = document.getElementById("admin-status-select");

if (statusSelect) {
  statusSelect.onchange = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== ADMIN_UID) return;

    await updateDoc(statusRef, {
      status: statusSelect.value,
      updatedAt: serverTimestamp()
    });
  };
}

// ===============================
// ADMIN: UPDATE CATATAN STATUS
// ===============================
const noteInput = document.getElementById("admin-status-note");

if (noteInput) {
  noteInput.onchange = async () => {
    const user = auth.currentUser;
    if (!user || user.uid !== ADMIN_UID) return;

    await updateDoc(statusRef, {
      note: noteInput.value,
      updatedAt: serverTimestamp()
    });
  };
}

// ===============================
// STATUS DAGANG HARI INI
// ===============================
onSnapshot(statusRef, (snap) => {
  if (!snap.exists()) return;

  const data = snap.data();
const select = document.getElementById("admin-status-select");
if (select && !select.classList.contains("hidden")) {
  select.value = data.status;
}
  const statusText = document.getElementById("status-text");
  const statusNote = document.getElementById("status-note");

  let icon = "üü¢";
  let color = "text-emerald-400";

  if (data.status === "LIBUR") {
    icon = "üî¥";
    color = "text-rose-400";
  } else if (data.status === "DI PASAR") {
    icon = "üß∫";
    color = "text-amber-400";
  } else if (data.status === "SELESAI") {
    icon = "‚èπ";
    color = "text-slate-400";
  }

  statusText.innerHTML = `<span class="${color}">${icon} ${data.status}</span>`;
  statusNote.innerText = data.note || "";
const noteInput = document.getElementById("admin-status-note");
if (noteInput && !noteInput.classList.contains("hidden")) {
  noteInput.value = data.note || "";
}
});

// Fungsi pembantu untuk mengembalikan tampilan Keranjang Belanja
function setDefaultCartBtn(btn) {
    btn.innerHTML = `
        <i data-lucide="shopping-cart" class="w-6 h-6 text-emerald-400"></i>
        <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-rose-500 text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
    `;
    btn.onclick = () => toggleCart();
}

        onSnapshot(
  query(productsRef, orderBy("pinCount", "desc"), orderBy("name", "asc")),
  (snapshot) => {
    allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCategories();
    renderProducts();
  }
);

        window.renderCategories = () => {
            const categories = ["Semua", "Sayur Mentah", "Buah", "Bumbu Dapur", "Ikan", "Daging", "Makanan", "Pangan", "Lainnya"];
            const list = document.getElementById('category-list');
            list.innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat}')" 
                    class="px-4 py-2 rounded-full whitespace-nowrap text-xs font-semibold transition-all ${currentCategory === cat ? 'bg-emerald-500 text-white' : 'bg-slate-900 text-slate-400 border border-slate-800'}">
                    ${cat}
                </button>
            `).join('');
        };

        window.setCategory = (cat) => {
            currentCategory = cat;
            renderCategories();
            renderProducts();
        };

// Fungsi untuk menangani input pencarian & memunculkan tombol X
window.handleSearchInput = () => {
    const input = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-search');
    
    // Munculkan tombol X jika ada teks, sembunyikan jika kosong
    if (input.value.length > 0) {
        clearBtn.classList.remove('hidden');
    } else {
        clearBtn.classList.add('hidden');
    }
    
    // Jalankan render produk seperti biasa
    renderProducts();
};

// Fungsi untuk membersihkan pencarian
window.clearSearch = () => {
    const input = document.getElementById('search-input');
    const clearBtn = document.getElementById('clear-search');
    
    input.value = ''; // Kosongkan input
    clearBtn.classList.add('hidden'); // Sembunyikan tombol X
    
    renderProducts(); // Render ulang produk (menampilkan semua)
    input.focus(); // Kembalikan fokus ke input
};

        window.renderProducts = () => {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const grid = document.getElementById('product-grid');
    const filtered = allProducts.filter(p => (currentCategory === "Semua" || p.category === currentCategory) && p.name.toLowerCase().includes(searchTerm));

filtered.sort((a, b) => {
  const aPinned = userPinnedProducts.has(a.id);
  const bPinned = userPinnedProducts.has(b.id);

  // 1Ô∏è‚É£ pinned oleh user sendiri ‚Üí paling atas
  if (aPinned && !bPinned) return -1;
  if (!aPinned && bPinned) return 1;

  // 2Ô∏è‚É£ sisanya urut pinCount
  return (b.pinCount || 0) - (a.pinCount || 0);
});

    if (filtered.length === 0) {
        grid.innerHTML = '<div class="col-span-2 text-center py-10 text-slate-500">Produk tidak ditemukan</div>';
        return;
    }

    // Ambil UID user saat ini untuk pengecekan admin
    const user = auth.currentUser;

    grid.innerHTML = filtered.map((p, index) => {
        // Tentukan link tujuan berdasarkan status admin
        const targetPage = (user && user.uid === ADMIN_UID) ? 'edit-product.html' : 'product.html';
        
        return `
            <div onclick="location.href='${targetPage}?id=${p.id}'"
                 class="bg-slate-900 rounded-2xl overflow-hidden border border-slate-800 flex flex-col shadow-lg cursor-pointer">
                <div class="relative h-32 bg-slate-800">
  <img src="${mediaGrid(p.image)}" class="w-full h-full object-cover">

  ${
    (user && user.uid === ADMIN_UID && index === 0 && p.pinCount > 0)
      ? `
      <div class="absolute top-2 left-2 bg-yellow-400 text-black text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1">
        üëë Terbanyak
      </div>
      `
      : ''
  }
                    <span class="absolute top-2 right-2 px-1.5 py-0.5 rounded text-[8px] font-bold uppercase ${p.status === 'Segar' ? 'bg-emerald-500 text-white' : 'bg-amber-500 text-white'}">${p.status}</span>
                </div>
                <div class="p-3 flex-1 flex flex-col">
                    <h3 class="font-bold text-sm truncate text-slate-100">${p.name}</h3>
                    <p class="text-[10px] text-slate-500">Stok: ${p.stock} ‚Ä¢ ${p.unit}</p>
                   <div class="mt-auto flex justify-between items-center gap-2">
  ${
    (!user || user.uid !== ADMIN_UID)
      ? `
      <button
  onclick="event.stopPropagation(); togglePin('${p.id}')"
  class="p-2 rounded-xl border border-slate-700
         ${userPinnedProducts.has(p.id)
           ? 'text-yellow-400 border-yellow-400'
           : 'text-slate-400 hover:text-yellow-400'}">
  <i data-lucide="pin" class="w-4 h-4"></i>
</button>
      `
      : ''
  }
    <span class="text-emerald-400 font-bold text-xs">
        Rp ${Number(p.price).toLocaleString()}
    </span>

    ${
      (user && user.uid === ADMIN_UID)
        ? `
        <div class="flex gap-1">
            <!-- TOMBOL -1 (TRANSAKSI OFFLINE TANPA PERINGATAN) -->
            <button
                onclick="event.stopPropagation(); decreaseStock('${p.id}')"
                class="bg-rose-500 p-2 rounded-xl text-white">
                <i data-lucide="minus" class="w-4 h-4"></i>
            </button>

            <!-- TOMBOL +1 -->
            <button
                onclick="event.stopPropagation(); addToCart('${p.id}')"
                class="bg-cyan-500 p-2 rounded-xl text-white">
                <i data-lucide="package-plus" class="w-4 h-4"></i>
            </button>
        </div>
        `
        : `
        <button
            onclick="event.stopPropagation(); addToCart('${p.id}')"
            class="bg-emerald-500 p-2 rounded-xl text-white">
            <i data-lucide="plus" class="w-4 h-4"></i>
        </button>
        `
    }
</div>
                </div>
            </div>
        `;
    }).join('');
    lucide.createIcons();
};

window.decreaseStock = async (id) => {
    const user = auth.currentUser;
    if (!user || user.uid !== ADMIN_UID) return;

    const product = allProducts.find(p => p.id === id);
    if (!product || product.stock <= 0) return; // ‚ùå diam-diam diblok

    try {
        const productRef = doc(db, "products", id);
        await updateDoc(productRef, {
            stock: increment(-1)
        });
    } catch (err) {
        console.error("Gagal mengurangi stok:", err);
    }
};

        window.addToCart = async (id) => {
    const user = auth.currentUser;

    // ADMIN ‚Üí tambah stok
    if (user && user.uid === ADMIN_UID) {
        try {
            const productRef = doc(db, "products", id);
            await updateDoc(productRef, {
                stock: increment(1)
            });
        } catch (err) {
            console.error("Gagal update stok:", err);
        }
        return;
    }

    // PELANGGAN ‚Üí tambah ke cart
    const product = allProducts.find(p => p.id === id);
    if (!product || product.stock <= 0) {
        alert("Stok habis!");
        return;
    }

    const existing = cart.find(item => item.id === id);

    if (existing) {
        if (existing.qty >= product.stock) {
            alert("Tidak bisa melebihi stok yang tersedia");
            return;
        }
        existing.qty++;
    } else {
        cart.push({
    id: product.id,
    name: product.name,
    price: product.price,
    image: product.image,
    qty: 1,
    unit: product.unit,
    stock: product.stock
});
    }

    // üîë WAJIB: simpan & update UI
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartUI();
};

window.togglePin = async (productId) => {
  const user = auth.currentUser;
  if (!user) {
    alert("Login dulu untuk pin produk");
    return;
  }

  const pinId = `${productId}_${user.uid}`;
  const pinRef = doc(db, "productPins", pinId);
  const productRef = doc(db, "products", productId);

  const snap = await getDoc(pinRef);

  if (snap.exists()) {
    // UNPIN
    await deleteDoc(pinRef);

    await setDoc(productRef, {
      pinCount: increment(-1)
    }, { merge: true });

  } else {
    // PIN
    await setDoc(pinRef, {
      productId,
      userId: user.uid,
      createdAt: serverTimestamp()
    });

    await setDoc(productRef, {
      pinCount: increment(1)
    }, { merge: true });
  }
};

function syncCart() {
    cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
}

window.updateCartUI = () => {
    cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    
    const badge = document.getElementById('cart-badge');
    const itemsContainer = document.getElementById('cart-items');
    const totalContainer = document.getElementById('cart-total');

    const count = cart.reduce((sum, item) => sum + item.qty, 0);

    if (badge) {
        badge.innerText = count;
        badge.classList.toggle('hidden', count === 0);
    }

    if (itemsContainer) {
        itemsContainer.innerHTML = cart.map(item => `
            <div class="flex gap-3 bg-slate-800/50 p-3 rounded-2xl border border-slate-800/50 items-center">
                <img src="${mediaThumb(item.image)}" class="w-12 h-12 rounded-lg object-cover">
                
                <div class="flex-1">
                    <h4 class="text-xs font-bold text-slate-100">${item.name}</h4>
                    <p class="text-[10px] text-slate-500 mb-1">Rp ${Number(item.price).toLocaleString()}</p>
                    
                    <div class="flex items-center gap-3">
                        <button onclick="updateQty('${item.id}', -1)" class="w-6 h-6 flex items-center justify-center bg-slate-700 rounded-md hover:bg-rose-500 transition-colors">
                            <i data-lucide="minus" class="w-3 h-3 text-white"></i>
                        </button>
                        <span class="text-xs font-bold text-emerald-400">${item.qty}</span>
                        <button onclick="updateQty('${item.id}', 1)" class="w-6 h-6 flex items-center justify-center bg-slate-700 rounded-md hover:bg-emerald-500 transition-colors">
                            <i data-lucide="plus" class="w-3 h-3 text-white"></i>
                        </button>
                    </div>
                </div>

                <button onclick="removeFromCart('${item.id}')" class="text-slate-500 hover:text-rose-500 p-2 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
    } // <--- Penutup blok if (itemsContainer)

    if (totalContainer) {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const method = document.querySelector('input[name="delivery"]:checked')?.value;
        const ongkir = method === "ANTAR" ? shippingFee : 0;

        document.getElementById("cart-subtotal").innerText = `Rp ${subtotal.toLocaleString()}`;
        document.getElementById("cart-shipping").innerText = ongkir === 0 ? "Gratis" : `Rp ${ongkir.toLocaleString()}`;
        totalContainer.innerText = `Rp ${(subtotal + ongkir).toLocaleString()}`;
    }

    lucide.createIcons();
}; // <--- Penutup fungsi updateCartUI


        window.toggleCart = () => document.getElementById('cart-modal').classList.toggle('hidden');
        window.removeFromCart = (id) => { cart = cart.filter(i => i.id !== id);
localStorage.setItem(CART_KEY, JSON.stringify(cart));
updateCartUI(); };
window.updateQty = (id, change) => {
    const item = cart.find(i => i.id === id);
    if (!item) return;

    const newQty = item.qty + change;

    if (newQty <= 0) {
        // Jika jumlah 0, hapus dari keranjang
        removeFromCart(id);
    } else if (newQty > item.stock) {
        // Jika melebihi stok
        alert("Stok tidak mencukupi!");
    } else {
        // Update jumlah
        item.qty = newQty;
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
        updateCartUI();
    }
};
        window.checkout = async function () {
    const user = auth.currentUser;
    if (!user) { alert("Silakan login dulu"); return; }
    if (cart.length === 0) { alert("Keranjang kosong"); return; }

    const method = document.querySelector('input[name="delivery"]:checked').value;
    const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
    const shipping = method === "ANTAR" ? shippingFee : 0;
    const total = subtotal + shipping;

    try {
        // Menggunakan runTransaction untuk memastikan stok diperiksa secara real-time sebelum dikurangi
        await runTransaction(db, async (transaction) => {
            const productUpdates = [];

            // 1. Validasi stok semua item
            for (const item of cart) {
                const productRef = doc(db, "products", item.id);
                const productDoc = await transaction.get(productRef);

                if (!productDoc.exists()) {
                    throw `Produk ${item.name} sudah tidak tersedia!`;
                }

                const currentDbStock = productDoc.data().stock;
                if (currentDbStock < item.qty) {
                    throw `Maaf, stok ${item.name} sisa ${currentDbStock}. Pesanan Anda (${item.qty}) melebihi stok.`;
                }

                productUpdates.push({ ref: productRef, newStock: currentDbStock - item.qty });
            }

            // 2. Jalankan update stok jika semua valid
            productUpdates.forEach(p => {
                transaction.update(p.ref, { stock: p.newStock });
            });

            // 3. Catat pesanan baru
            const orderRef = doc(collection(db, "orders"));
            transaction.set(orderRef, {
                userId: user.uid,
                userName: user.displayName || user.email,
                items: cart.map(i => ({
                    productId: i.id,
                    name: i.name,
                    qty: i.qty,
                    price: i.price
                })),
                subtotal,
                shipping,
                total,
                deliveryMethod: method,
                status: "MENUNGGU",
                createdAt: serverTimestamp(),
                cancelableUntil: Date.now() + (5 * 60 * 1000)
            });
        });

        // 4. Reset keranjang jika berhasil
        cart = [];
        localStorage.removeItem(CART_KEY);
        updateCartUI();
        toggleCart();

        alert("Pesanan berhasil dibuat üéâ Stok telah diperbarui otomatis.");
        window.location.href = "profile.html";

    } catch (err) {
        console.error("Checkout gagal: ", err);
        // Alert ini akan muncul jika stok di database tiba-tiba habis saat user klik tombol
        alert(err);
    }
};



        lucide.createIcons();

window.addEventListener('focus', () => {
    cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
    if (typeof updateCartUI === 'function') {
        updateCartUI();
    }
});

window.addEventListener('load', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('action') === 'checkout') {
            const cartModal = document.getElementById('cart-modal');
            if (cartModal) {
                // Beri sedikit jeda agar data keranjang siap
                setTimeout(() => {
                    cartModal.classList.remove('hidden');
                    if (typeof window.updateCartUI === 'function') {
                        window.updateCartUI();
                    }
                }, 300); 
            }
        }
    });
    </script>
</body>
</html>
