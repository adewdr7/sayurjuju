<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kelola Pesanan - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .status-badge { @apply px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen pb-10">

<nav class="p-4 flex items-center justify-between sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
  <div class="flex items-center gap-3">
    <a href="index.html" class="p-2 bg-slate-900 rounded-xl border border-slate-800 hover:text-emerald-400 transition-colors">
      <i data-lucide="arrow-left"></i>
    </a>
    <h1 class="font-bold text-lg text-emerald-400">Daftar Pesanan</h1>
  </div>
  <div class="text-right">
    <p class="text-[10px] text-slate-500 uppercase font-bold">Total Omzet</p>
    <p id="total-revenue" class="text-emerald-400 font-black">Rp 0</p>
  </div>
</nav>

<main class="p-4 max-w-2xl mx-auto">
  <div id="order-list" class="space-y-4">
    <!-- Pesanan akan muncul di sini -->
    <div class="animate-pulse space-y-4">
      <div class="h-32 bg-slate-900 rounded-3xl border border-slate-800"></div>
      <div class="h-32 bg-slate-900 rounded-3xl border border-slate-800"></div>
    </div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
  import { getFirestore, collection, doc, onSnapshot, updateDoc, writeBatch, increment, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = JSON.parse(__firebase_config);
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'pasar-segar-v2';

  // Auth
  const initAuth = async () => {
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
      await signInWithCustomToken(auth, __initial_auth_token);
    } else {
      await signInAnonymously(auth);
    }
  };
  initAuth();

  // Load Orders
  onAuthStateChanged(auth, (user) => {
    if (user) {
      const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
      onSnapshot(ordersRef, (snapshot) => {
        const listEl = document.getElementById('order-list');
        listEl.innerHTML = '';
        let revenue = 0;

        const orders = [];
        snapshot.forEach(doc => orders.push({id: doc.id, ...doc.data()}));
        
        // Urutkan terbaru
        orders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

        orders.forEach(order => {
          if(order.status === 'SELESAI') revenue += order.total;

          const card = document.createElement('div');
          card.className = `bg-slate-900 border ${order.status === 'DIBATALKAN' ? 'border-rose-900/30 opacity-60' : 'border-slate-800'} rounded-[2rem] p-5 relative overflow-hidden`;
          
          card.innerHTML = `
            <div class="flex justify-between items-start mb-4">
              <div>
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">ID: #${order.id.slice(-5)}</p>
                <h3 class="font-bold text-slate-200">${order.userName || 'Pelanggan'}</h3>
                <p class="text-xs text-slate-400">${order.deliveryMethod === 'DIANTAR' ? 'ðŸšš Diantar' : 'ðŸš¶ Ambil Sendiri'}</p>
              </div>
              <span class="status-badge ${getStatusClass(order.status)}">${order.status}</span>
            </div>

            <div class="space-y-2 mb-4 border-y border-slate-800/50 py-3">
              ${order.items.map(item => `
                <div class="flex justify-between text-xs">
                  <span class="text-slate-400">${item.name} x${item.qty}</span>
                  <span class="font-bold">Rp ${(item.price * item.qty).toLocaleString()}</span>
                </div>
              `).join('')}
            </div>

            <div class="flex justify-between items-center">
              <div>
                <p class="text-[10px] text-slate-500 uppercase font-bold">Total Bayar</p>
                <p class="text-lg font-black text-emerald-400">Rp ${order.total.toLocaleString()}</p>
              </div>
              <div class="flex gap-2">
                ${order.status === 'MENUNGGU' ? `
                  <button onclick="updateStatus('${order.id}', 'SELESAI')" class="bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-bold px-4 py-2 rounded-xl transition-all">
                    Konfirmasi & Kurangi Stok
                  </button>
                  <button onclick="cancelOrder('${order.id}')" class="bg-slate-800 hover:bg-rose-500 text-slate-400 hover:text-white text-xs font-bold px-4 py-2 rounded-xl transition-all">
                    Batal
                  </button>
                ` : order.status === 'SELESAI' ? `
                   <button onclick="revertOrder('${order.id}')" class="bg-rose-500/10 text-rose-400 border border-rose-500/20 text-[10px] font-bold px-3 py-2 rounded-xl hover:bg-rose-500 hover:text-white transition-all">
                    Batalkan & Kembalikan Stok
                  </button>
                ` : ''}
              </div>
            </div>
          `;
          listEl.appendChild(card);
        });

        document.getElementById('total-revenue').innerText = `Rp ${revenue.toLocaleString()}`;
        lucide.createIcons();
      });
    }
  });

  function getStatusClass(status) {
    switch(status) {
      case 'MENUNGGU': return 'bg-amber-500/10 text-amber-500 border border-amber-500/20';
      case 'SELESAI': return 'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20';
      case 'DIBATALKAN': return 'bg-rose-500/10 text-rose-500 border border-rose-500/20';
      default: return 'bg-slate-800 text-slate-400';
    }
  }

  // KONFIRMASI: Kurangi Stok & Tambah Loyalitas
  window.updateStatus = async (orderId, nextStatus) => {
    try {
      const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
      const orderSnap = await getDoc(orderRef);
      const orderData = orderSnap.data();

      const batch = writeBatch(db);

      // 1. Kurangi Stok Produk
      for (const item of orderData.items) {
        const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.id);
        batch.update(productRef, { stock: increment(-item.qty) });
      }

      // 2. Tambah Pengeluaran (Loyalitas) User
      const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', orderData.userId);
      batch.set(userRef, { 
        totalSpent: increment(orderData.total),
        lastTransaction: serverTimestamp()
      }, { merge: true });

      // 3. Update Status Order
      batch.update(orderRef, { status: nextStatus });

      await batch.commit();
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

  // BATALKAN: Kembalikan Stok & Kurangi Loyalitas (Hanya jika status sebelumnya SELESAI)
  window.revertOrder = async (orderId) => {
    if (!confirm("Batalkan pesanan ini? Stok dan pengeluaran pelanggan akan dikembalikan.")) return;

    try {
      const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
      const orderSnap = await getDoc(orderRef);
      const orderData = orderSnap.data();

      const batch = writeBatch(db);

      // 1. Kembalikan Stok Produk
      for (const item of orderData.items) {
        const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.id);
        batch.update(productRef, { stock: increment(item.qty) });
      }

      // 2. Kurangi Pengeluaran (Loyalitas) User
      const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', orderData.userId);
      batch.update(userRef, { 
        totalSpent: increment(-orderData.total)
      });

      // 3. Update Status Order ke DIBATALKAN
      batch.update(orderRef, { status: "DIBATALKAN" });

      await batch.commit();
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

  // Pembatalan Pesanan yang Belum Selesai (Tidak ada urusan stok)
  window.cancelOrder = async (orderId) => {
    if (!confirm("Batalkan pesanan ini?")) return;
    try {
      const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
      await updateDoc(orderRef, { status: "DIBATALKAN" });
    } catch (err) {
      alert("Error: " + err.message);
    }
  };

</script>
</body>
</html>


