<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kelola Pesanan - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen pb-10">

<nav class="p-4 flex items-center justify-between sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
  <div class="flex items-center gap-3">
    <a href="index.html"
   class="p-2 bg-slate-900 rounded-xl border border-slate-800
          hover:text-emerald-400 transition-colors
          flex items-center justify-center w-10 h-10">
  <i data-lucide="arrow-left" class="w-5 h-5"></i>
</a>

    <h1 class="font-bold text-lg text-emerald-400">Daftar Pesanan</h1>
  </div>
  <div id="revenue-today" class="text-right">
    <p class="text-[10px] text-slate-500 uppercase font-bold">Pendapatan Hari Ini</p>
    <p id="total-revenue" class="text-emerald-400 font-bold">Rp 0</p>
  </div>
</nav>

<main class="p-4 space-y-4 max-w-2xl mx-auto">
<div class="bg-slate-900 border border-slate-800 rounded-2xl p-4 mb-6">
    <label class="block text-[10px] text-slate-500 font-bold mb-2 uppercase tracking-widest">Biaya Antar (Rp)</label>
<p id="current-shipping"
   class="text-[11px] text-slate-400 mb-3">
  Ongkir saat ini: Rp 0
</p>
    <div class="flex justify-end gap-2">
        <input type="number" id="shipping-input" class="w-full max-w-[150px] bg-slate-950 border border-slate-800 rounded-xl px-4 py-2 text-sm focus:border-emerald-500 outline-none" placeholder="Contoh: 5000">
        <button onclick="updateShippingFee()" class="px-6 py-2 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 transition-all">Simpan</button>
    </div>
</div>


  <!-- Ringkasan Status -->
  <div class="grid grid-cols-3 gap-3 mb-6">
    <div class="bg-slate-900 border border-slate-800 p-3 rounded-2xl text-center">
      <p id="count-pending" class="text-xl font-bold text-amber-500">0</p>
      <p class="text-[10px] text-slate-500">Menunggu</p>
    </div>
    <div class="bg-slate-900 border border-slate-800 p-3 rounded-2xl text-center">
      <p id="count-process" class="text-xl font-bold text-cyan-400">0</p>
      <p class="text-[10px] text-slate-500">Proses</p>
    </div>
    <div class="bg-slate-900 border border-slate-800 p-3 rounded-2xl text-center">
      <p id="count-done" class="text-xl font-bold text-emerald-500">0</p>
      <p class="text-[10px] text-slate-500">Selesai</p>
    </div>
  </div>

<button onclick="clearFinishedOrders()" class="w-full mb-4 py-3 bg-slate-900 text-rose-500 border border-slate-800 rounded-2xl text-xs font-bold flex items-center justify-center gap-2">
    <i data-lucide="trash-2" class="w-4 h-4"></i>
    Bersihkan Semua Pesanan Selesai
</button>

  <div id="orders-list" class="space-y-4">
    <p class="text-slate-500 text-center py-10">Memuat pesanan...</p>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot,
  doc,
setDoc, 
  updateDoc,
  getDoc,
  serverTimestamp,
  increment, 
  deleteDoc, 
  getDocs, 
  where, 
  writeBatch
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
  authDomain: "sayurjuju-bfe82.firebaseapp.com",
  projectId: "sayurjuju-bfe82",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const shippingRef = doc(db, "settings", "shipping");

// load ongkir awal
onSnapshot(shippingRef, (snap) => {
  if (snap.exists()) {
    const fee = snap.data().fee ?? 0;
    document.getElementById("shipping-input").value = fee;
    document.getElementById("current-shipping").innerText =
      fee === 0
        ? "Ongkir saat ini: GRATIS"
        : `Ongkir saat ini: Rp ${fee.toLocaleString()}`;
  }
});

// simpan ongkir
window.updateShippingFee = async () => {
  const fee = Number(document.getElementById("shipping-input").value || 0);

  await setDoc(
    shippingRef,
    {
      fee: fee,
      updatedAt: serverTimestamp()
    },
    { merge: true }
  );

  alert(fee === 0 ? "Ongkir digratiskan" : "Ongkir diperbarui");
document.getElementById("current-shipping").innerText =
  fee === 0
    ? "Ongkir saat ini: GRATIS"
    : `Ongkir saat ini: Rp ${fee.toLocaleString()}`;
};

const ADMIN_UID = "XVmdoXxSptTlA8xHVmAIzeLgkru2";

window.clearFinishedOrders = async () => {
    if (!confirm("Hapus semua pesanan dengan status 'SELESAI'? Tindakan ini tidak dapat dibatalkan.")) return;
    
    const q = query(
  collection(db, "orders"),
  where("status", "in", ["SELESAI", "DIBATALKAN"])
);

const snap = await getDocs(q);
    
    const batch = writeBatch(db);
    snap.forEach(d => batch.delete(d.ref));
    
    await batch.commit();
    alert("Daftar pesanan selesai telah dibersihkan.");
};

// Fungsi hapus satuan untuk admin
window.deleteSingleOrder = async (id) => {
    if (!confirm("Hapus pesanan ini?")) return;
    await deleteDoc(doc(db, "orders", id));
};

const ordersList = document.getElementById("orders-list");

onAuthStateChanged(auth, (user) => {
  if (!user || user.uid !== ADMIN_UID) {
    window.location.href = "index.html";
    return;
  }
  loadOrders();
});

function loadOrders() {
  const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));

  onSnapshot(q, async (snap) => {
    ordersList.innerHTML = "";
    let totalRev = 0;
    let counts = { pending: 0, process: 0, done: 0 };

    if (snap.empty) {
      ordersList.innerHTML = `<p class="text-center text-slate-500 py-10">Belum ada pesanan yang masuk.</p>`;
      return;
    }

    for (const docSnap of snap.docs) {

const o = docSnap.data();
const id = docSnap.id;

const userSnap = await getDoc(doc(db, "users", o.userId));
const buyerName = userSnap.exists()
  ? userSnap.data().name || "Tanpa Nama"
  : "User";

// Di dalam loop snap.forEach
const deleteBtn =
  (o.status === "SELESAI" || o.status === "DIBATALKAN")
    ? `
      <button onclick="deleteSingleOrder('${id}')"
        class="p-2 text-rose-500 hover:bg-rose-500/10 rounded-lg">
        <i data-lucide="trash-2" class="w-4 h-4"></i>
      </button>
    `
    : "";
// Masukkan variabel deleteBtn ke dalam template literal card di bagian header

      
      // Hitung ringkasan
      if (o.status === "MENUNGGU" || o.status === "SIAP DIAMBIL") counts.pending++;
      else if (o.status === "DIANTAR") counts.process++;
      else if (o.status === "SELESAI") {
          counts.done++;
          totalRev += o.total;
      }

      const dateStr = o.createdAt ? new Date(o.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';

      const card = document.createElement("div");
      card.className = "bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-xl";

      card.innerHTML = `
  <div class="p-4 border-b border-slate-800 flex justify-between items-start">
    <div>
      <div class="flex items-center gap-2 mb-1">
        <span class="text-[10px] font-bold px-2 py-0.5 rounded ${o.deliveryMethod === 'ANTAR' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-cyan-500/10 text-cyan-400'}">
          ${o.deliveryMethod === 'ANTAR' ? 'ðŸ›µ ANTAR' : 'ðŸš¶ AMBIL'}
        </span>
        <span class="text-[10px] text-slate-500 font-mono">#${id.slice(-5).toUpperCase()}</span>
      </div>
      <p class="text-xs font-bold text-slate-200">
  ðŸ‘¤ ${buyerName}
</p>
    </div>
    
    <div class="flex items-start gap-2">
      <div class="text-right">
        <p class="text-xs font-bold text-slate-400">${dateStr}</p>
        <span class="text-[10px] font-bold uppercase ${getStatusColor(o.status)}">${o.status}</span>
      </div>
      
      ${deleteBtn} 
    </div>
  </div>

        <div class="p-4 bg-slate-900/50">
          <ul class="space-y-2 mb-3">
            ${o.items.map(i => `
              <li class="flex justify-between text-xs">
                <span class="text-slate-400">${i.qty}x ${i.name}</span>
                <span class="text-slate-200">Rp ${(i.price * i.qty).toLocaleString()}</span>
              </li>
            `).join("")}
          </ul>
          
          <div class="flex justify-between items-center pt-2 border-t border-slate-800">
            <span class="text-xs text-slate-500">Total Pembayaran</span>
            <span class="text-emerald-400 font-bold">Rp ${o.total.toLocaleString()}</span>
          </div>
        </div>

    <div class="p-4 bg-slate-900 flex gap-2">
  ${
    o.status !== "SELESAI" && o.status !== "DIBATALKAN"
      ? `
        <button onclick="updateStatus('${id}', '${o.status}')"
          class="flex-1 bg-emerald-500 hover:bg-emerald-400 text-slate-950 py-3 rounded-xl text-xs font-bold transition-colors active:scale-95">
          ${getNextActionLabel(o.status)}
        </button>
      `
      : o.status === "SELESAI"
        ? `
          <div class="flex-1 text-center py-2 bg-slate-800 rounded-xl border border-slate-700">
            <span class="text-xs text-slate-500 font-bold">
              âœ“ Pesanan Selesai
            </span>
          </div>
        `
        : `
          <div class="flex-1 text-center py-2 bg-rose-500/10 rounded-xl border border-rose-500/30">
            <span class="text-xs text-rose-400 font-bold">
              âœ– Pesanan Dibatalkan Pelanggan
            </span>
          </div>
        `
  }
</div>
      `;

      ordersList.appendChild(card);
}


    // Update Header
    document.getElementById("total-revenue").innerText = `Rp ${totalRev.toLocaleString()}`;
    document.getElementById("count-pending").innerText = counts.pending;
    document.getElementById("count-process").innerText = counts.process;
    document.getElementById("count-done").innerText = counts.done;

    lucide.createIcons();
  });
}

function getStatusColor(status) {
    if (status === "MENUNGGU") return "text-amber-500";
    if (status === "DIANTAR") return "text-cyan-400";
    if (status === "SELESAI") return "text-emerald-500";
    if (status === "SIAP DIAMBIL") return "text-amber-500";
    if (status === "DIBATALKAN") return "text-rose-500";
    return "text-slate-400";
}

function getNextActionLabel(current) {
    if (current === "MENUNGGU") return "Proses & Antar ðŸ›µ";
    if (current === "SIAP DIAMBIL") return "Tandai Diambil ðŸš¶";
    if (current === "DIANTAR") return "Selesaikan Pesanan âœ“";
    return "Update Status";
}


window.updateStatus = async (id, current) => {
    let next = "SELESAI";
    if (current === "MENUNGGU") next = "DIANTAR";
    else if (current === "DIANTAR" || current === "SIAP DIAMBIL") next = "SELESAI";

    try {
        const orderRef = doc(db, "orders", id);
        const orderSnap = await getDoc(orderRef);
        const orderData = orderSnap.data();

        if (next === "SELESAI") {
            const batch = writeBatch(db);

            // 1. Kurangi stok produk
            for (const item of orderData.items) {
                const pRef = doc(db, "products", item.productId);
                batch.update(pRef, { stock: increment(-item.qty) });
            }

            // 2. Update data user
            const userRef = doc(db, "users", orderData.userId);
            batch.update(userRef, {
                lastTransactionAt: serverTimestamp(),
                orderCount: increment(1),
                totalSpent: increment(orderData.total)
            });

            // 3. Update status pesanan & Waktu Update
            batch.update(orderRef, { 
                status: next, 
                updatedAt: serverTimestamp() 
            });
            
            await batch.commit();
        } else {
            // Update status untuk tahapan antara (MENUNGGU -> DIANTAR)
            await updateDoc(orderRef, { 
                status: next, 
                updatedAt: serverTimestamp() 
            });
        }

        alert(`Pesanan berhasil diupdate ke: ${next}`);
    } catch (err) {
        console.error(err);
        alert("Gagal mengupdate status: " + err.message);
    }
};
lucide.createIcons(); 

</script>
</body>
</html>











