<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Pasar Segar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm">
        <div class="text-center mb-8">
            <a href="index.html" class="inline-flex items-center gap-2 text-emerald-400 font-bold text-xl mb-2">
                <i data-lucide="shopping-bag"></i> Pasar Segar
            </a>
            <p class="text-slate-500 text-sm">Masuk untuk berbelanja atau mengelola toko</p>
        </div>

        <div id="login-card" class="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl">
            <div id="login-form" class="space-y-4">
                <!-- Input Email -->
                <div>
                    <label class="block text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">Email</label>
                    <input id="user-email" type="email" placeholder="email@contoh.com" 
                        class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-white">
                </div>
                
                <!-- Input Password -->
<div>
  <label class="block text-xs text-slate-400 mb-2 uppercase tracking-wider font-semibold">
    Password
  </label>

  <div class="relative">
    <input
      id="user-password"
      type="password"
      placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
      class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 pr-12 text-sm
             focus:ring-2 focus:ring-emerald-500 outline-none transition-all text-white"
    />

    <button
      type="button"
      onclick="togglePassword()"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-emerald-400"
      aria-label="Lihat password">
      <i id="eye-icon" data-lucide="eye" class="w-5 h-5"></i>
    </button>
  </div>
</div>
<p class="text-right text-xs">
  <button
    type="button"
    onclick="openResetPassword()"
    class="text-emerald-400 hover:underline">
    Lupa sandi?
  </button>
</p>

                <!-- Tombol Masuk -->
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-emerald-500 hover:bg-emerald-600 py-4 rounded-2xl font-bold shadow-lg shadow-emerald-900/20 transition-all flex justify-center items-center gap-2 text-slate-950">
                    Masuk Sekarang
                </button>
                
                <!-- Pembatas -->
                <div class="flex items-center my-4">
                    <div class="flex-1 h-[1px] bg-slate-800"></div>
                    <span class="px-3 text-[10px] text-slate-600 font-bold">ATAU</span>
                    <div class="flex-1 h-[1px] bg-slate-800"></div>
                </div>

                <!-- Tombol Daftar -->
                <button onclick="handleRegister()" id="btn-register" class="w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl font-bold transition-all border border-slate-700">
                    Daftar Akun Baru
                </button>

                <p class="text-center text-[10px] text-slate-500 mt-4 leading-relaxed">
                    Dengan masuk atau mendaftar, Anda menyetujui ketentuan layanan kami. Verifikasi email diperlukan untuk pendaftaran baru.
                </p>
            </div>
        </div>
    </div>

<div id="reset-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/70" onclick="closeResetPassword()"></div>

  <div class="relative max-w-sm mx-auto mt-32 bg-slate-900 p-6 rounded-3xl border border-slate-800">
    <h2 class="font-bold text-lg mb-3">Reset Password</h2>

    <input
      id="reset-email"
      type="email"
      placeholder="Masukkan email terdaftar"
      class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm mb-4"
    />

    <button
      onclick="sendResetPassword()"
      class="w-full bg-emerald-500 py-4 rounded-2xl font-bold text-slate-950">
      Kirim Email Reset
    </button>
  </div>
</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            sendEmailVerification,
sendPasswordResetEmail, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
            authDomain: "sayurjuju-bfe82.firebaseapp.com",
            projectId: "sayurjuju-bfe82",
            storageBucket: "sayurjuju-bfe82.firebasestorage.app",
            messagingSenderId: "754413439458",
            appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
window.openResetPassword = () => {
  const loginEmail = document.getElementById("user-email").value;
  document.getElementById("reset-email").value = loginEmail || "";
  document.getElementById("reset-modal").classList.remove("hidden");
};

window.closeResetPassword = () => {
  document.getElementById("reset-modal").classList.add("hidden");
};

window.sendResetPassword = async () => {
  const email = document.getElementById("reset-email").value.trim();

  if (!email) {
    alert("Masukkan email terlebih dahulu");
    return;
  }

  try {
    await sendPasswordResetEmail(auth, email);
    alert("Link reset password telah dikirim ke email ðŸ“©");
    closeResetPassword();
  } catch (err) {
    console.error(err);
    alert("Gagal mengirim email reset");
  }
};
        const db = getFirestore(app);

        // Atur bahasa email ke Indonesia
        auth.languageCode = 'id';

        const ADMIN_UID = "XVmdoXxSptTlA8xHVmAIzeLgkru2";

window.togglePassword = () => {
  const input = document.getElementById("user-password");
  const icon = document.getElementById("eye-icon");

  const isHidden = input.type === "password";

  input.type = isHidden ? "text" : "password";
  icon.setAttribute("data-lucide", isHidden ? "eye-off" : "eye");

  lucide.createIcons();
};

        // Fungsi LOGIN
        window.handleLogin = async () => {
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-password').value;
            const btn = document.getElementById('btn-login');

            if(!email || !pass) return alert("Mohon isi email dan password!");

            btn.innerText = "Memproses...";
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                // Cek apakah email sudah diverifikasi (Admin dikecualikan)
                if (!user.emailVerified && user.uid !== ADMIN_UID) {
                    alert("Email Anda belum diverifikasi. Silakan cek kotak masuk atau folder spam email Anda.");
                    await signOut(auth);
                    location.reload();
                    return;
                }

                await ensureUserDoc(user);
                window.location.href = "index.html";
            } catch (err) {
                let message = "Gagal masuk: ";
                if(err.code === 'auth/invalid-credential') message += "Email atau password salah.";
                else if(err.code === 'auth/user-disabled') message += "Akun ini telah dinonaktifkan.";
                else message += err.message;
                
                alert(message);
                btn.innerText = "Masuk Sekarang";
                btn.disabled = false;
            }
        };

        // Fungsi DAFTAR
        window.handleRegister = async () => {
            const email = document.getElementById('user-email').value;
            const pass = document.getElementById('user-password').value;
            const btn = document.getElementById('btn-register');

            if(!email || !pass) return alert("Isi email dan password untuk mendaftar!");
            if(pass.length < 6) return alert("Password minimal 6 karakter!");

            btn.innerText = "Mendaftarkan...";
            btn.disabled = true;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;

                // Kirim Email Verifikasi
                await sendEmailVerification(user);
                
                // Inisialisasi data di Firestore
                await ensureUserDoc(user);
                
                alert("Pendaftaran berhasil! Kami telah mengirimkan link verifikasi ke email Anda. Silakan verifikasi sebelum login.");
                
                // Keluar agar user harus verifikasi dulu
                await signOut(auth);
                location.reload();
            } catch (err) {
                let message = "Gagal mendaftar: ";
                if(err.code === 'auth/email-already-in-use') message += "Email sudah terdaftar.";
                else message += err.message;
                
                alert(message);
                btn.innerText = "Daftar Akun Baru";
                btn.disabled = false;
            }
        };

        // Fungsi Memastikan Dokumen User ada di Firestore
        async function ensureUserDoc(user) {
            const userDocRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userDocRef);
            
            if (!userSnap.exists()) {
                await setDoc(userDocRef, {
                    name: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    address: "Alamat belum diatur",
                    photo: `https://ui-avatars.com/api/?name=${user.email}&background=random&size=128`,
                    totalSpent: 0,
                    debt: 0,
                    role: user.uid === ADMIN_UID ? "admin" : "customer",
                    createdAt: new Date().toISOString()
                });
            }
        }

        // Jalankan icon Lucide
        lucide.createIcons();
    </script>
</body>
</html>




