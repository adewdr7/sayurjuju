<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Pasar Segar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen pb-20">

    <!-- Navigasi -->
    <nav class="p-4 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
        <div class="flex items-center gap-3">
            <a href="index.html" class="p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </a>
            <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Profil Saya</h1>
        </div>
        <button onclick="handleLogout()" class="p-2 bg-rose-500/10 text-rose-500 rounded-xl border border-rose-500/20">
            <i data-lucide="log-out" class="w-6 h-6"></i>
        </button>
    </nav>

    <main class="p-4 max-w-2xl mx-auto space-y-6">

        <!-- ================= PROFIL USER ================= -->
        <div class="bg-slate-900 rounded-[2rem] p-6 border border-slate-800 relative overflow-hidden">
            <div class="flex items-center gap-5 relative z-10">
                <div class="relative">
                    <img id="user-photo" src="https://ui-avatars.com/api/?name=User&background=random" class="w-20 h-20 rounded-2xl object-cover border-2 border-slate-800 shadow-2xl">
                    <div id="user-role-badge" class="absolute -bottom-2 -right-2 bg-emerald-500 text-slate-950 text-[10px] font-bold px-2 py-1 rounded-lg uppercase border-2 border-slate-900">Customer</div>
                </div>
                <div>
                    <h2 id="user-name" class="text-xl font-bold text-white mb-1">Memuat...</h2>
                    <p id="user-email" class="text-xs text-slate-500 mb-2">email@contoh.com</p>
                    <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded-md border border-slate-700">
                        <i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>
                        <span id="user-address">Alamat belum diatur</span>
                    </span>
                </div>
            </div>

            <div id="user-stats" class="grid grid-cols-2 gap-3 mt-8">
                <div class="bg-slate-950/50 p-4 rounded-2xl border border-slate-800/50">
  <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">
    Frekuensi Transaksi
  </p>
  <p class="text-lg font-bold text-emerald-400">
    <span id="user-freq">0%</span>
  </p>
</div>
<div class="bg-slate-900 border border-slate-800 p-4 rounded-2xl mt-4">
  <p class="text-xs text-slate-500 mb-1">Frekuensi Belanja</p>
  <p id="order-count" class="text-lg font-bold text-cyan-400"></p>
  <p id="loyalty-label" class="text-xs text-slate-400 mt-1"></p>
</div>
                <div class="bg-slate-950/50 p-4 rounded-2xl border border-slate-800/50">
                    <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Catatan Hutang</p>
                    <p class="text-lg font-bold text-rose-400">Rp <span id="user-debt">0</span></p>
                </div>
            </div>
        </div>

        <!-- ================= PESANAN SAYA ================= -->
        <section id="orders-section" class="bg-slate-900 rounded-[2rem] p-5 border border-slate-800">
 <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-white mb-3">Pesanan Saya</h3>
 <button onclick="toggleSelectMode()" class="text-[10px] font-bold text-rose-400 bg-rose-400/10 px-3 py-1.5 rounded-lg border border-rose-400/20">
            Kelola Hapus
        </button>
    </div>
<div id="delete-controls" class="hidden flex justify-between items-center mb-3 bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
        <button onclick="deleteSelectedOrders()" class="text-xs font-bold text-rose-500 bg-rose-500/20 px-4 py-2 rounded-xl border border-rose-500/30">
            Hapus Terpilih (<span id="selected-count">0</span>)
        </button>
        <button onclick="toggleSelectMode()" class="text-xs text-slate-400 font-bold">Batal</button>
    </div>

            <div id="my-orders" class="space-y-3 max-h-[60vh] overflow-y-auto hide-scrollbar pr-1">
                <p class="text-slate-500 text-sm">Memuat pesanan...</p>
            </div>
        </section>

        <!-- ================= ADMIN SECTION ================= -->
        <div id="admin-section" class="hidden space-y-4">
            <h3 class="text-lg font-bold text-white">Daftar Pelanggan</h3>
            <div class="flex gap-3 mb-4">
  <button
  onclick="toggleSort(this)" 
  class="flex-1 py-3 bg-slate-800 rounded-xl text-xs font-bold transition-all active:scale-95">
  üîÅ Urutkan (Belanja)
</button>

  <button
    onclick="resetAllFrequency()"
    class="flex-1 py-3 bg-rose-500/10 text-rose-500 rounded-xl text-xs font-bold border border-rose-500/20">
    ‚ôª Reset Frekuensi
  </button>
</div>

<div id="users-list" class="space-y-3"></div>
        </div>

    </main>

    <!-- Modal Edit Admin -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-900 w-full max-w-sm rounded-[2.5rem] p-8 border border-slate-800 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-6">Edit Data Pelanggan</h3>
            <div class="space-y-5">
                <div>
 <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2">Nama Pelanggan</label>
                <input type="text" id="edit-name" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-blue-500 text-white">
            </div>
<div>
                    <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2">Frekuensi Belanja</label>
                    <input type="number" id="edit-freq" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2">Catatan Hutang (Rp)</label>
                    <input type="number" id="edit-debt" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-rose-500">
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeEditModal()" class="flex-1 py-4 bg-slate-800 rounded-2xl font-bold text-sm">Batal</button>
                    <button onclick="saveUserEdit()" class="flex-1 py-4 bg-emerald-500 text-slate-950 rounded-2xl font-bold text-sm shadow-lg shadow-emerald-500/20">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Ganti seluruh isi tag <script type="module"> pada profile.html dengan kode ini:

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, query, orderBy, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
    authDomain: "sayurjuju-bfe82.firebaseapp.com",
    projectId: "sayurjuju-bfe82",
    storageBucket: "sayurjuju-bfe82.firebasestorage.app",
    messagingSenderId: "754413439458",
    appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);



const ADMIN_UID = "XVmdoXxSptTlA8xHVmAIzeLgkru2";
let currentSort = "spent"; // spent | debt
let targetEditUid = null;
let activeTimers = {};

// Tambahkan fungsi pendukung di dalam tag <script>
let selectedOrders = [];

window.toggleSelectMode = () => {
    selectedOrders = [];
    document.getElementById('delete-controls').classList.toggle('hidden');
    
    // Ambil UID user yang sedang login untuk memuat ulang list
    const user = auth.currentUser;
    if (user) loadMyOrders(user.uid); 
};


window.toggleOrderSelection = (id) => {
    const index = selectedOrders.indexOf(id);
    if (index > -1) {
        selectedOrders.splice(index, 1);
    } else {
        selectedOrders.push(id);
    }
    document.getElementById('selected-count').innerText = selectedOrders.length;
    
    // Opsional: Beri border merah pada kartu yang dipilih secara manual tanpa reload
    const user = auth.currentUser;
    if (user) loadMyOrders(user.uid); 
};


window.deleteSelectedOrders = async () => {
    if (!confirm(`Hapus ${selectedOrders.length} pesanan?`)) return;
    const { deleteDoc, doc } = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js");
    
    for (const id of selectedOrders) {
        await deleteDoc(doc(db, "orders", id));
    }
    selectedOrders = [];
    document.getElementById('delete-controls').classList.add('hidden');
};


window.toggleSort = (btn) => {
  // 1. Ganti status sort
  currentSort = currentSort === "spent" ? "debt" : "spent";

  // 2. Ganti teks dan warna tombol untuk memberi indikasi visual
  if (currentSort === "spent") {
    btn.innerText = "üîÅ Urutkan (Belanja)";
    btn.classList.replace("text-rose-400", "text-emerald-400"); // Jika ingin ganti warna
  } else {
    btn.innerText = "üîÅ Urutkan (Hutang)";
    btn.classList.replace("text-emerald-400", "text-rose-400");
  }

  // 3. Panggil ulang loadUsers dengan nilai maxSpent yang tersimpan
  // Pastikan Anda menyimpan maxSpent ke variabel global atau mengambilnya kembali
  loadUsers(window.__maxSpent || 0);
};


window.resetAllFrequency = async () => {
  if (!confirm("Reset semua frekuensi belanja ke 0% ?")) return;

  try {
    const snap = await getDocs(collection(db, "users"));

    const batchUpdates = [];

    snap.forEach(docSnap => {
      if (docSnap.id !== ADMIN_UID) {
        batchUpdates.push(
          updateDoc(doc(db, "users", docSnap.id), {
            totalSpent: 0,
orderCount: 0

          })
        );
      }
    });

    await Promise.all(batchUpdates);

    alert("Semua frekuensi berhasil di-reset");
    location.reload();
  } catch (err) {
    alert(err.message);
  }
};

// Tambahkan ini di bagian script profile.html Anda
const CART_KEY = "pasar_cart";
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];


onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // =============================
  // 1. AMBIL DATA USER SENDIRI
  // =============================
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    console.error("User document belum ada");
    return;
  }

  const userData = userSnap.data();

  // =============================
  // 2. TAMPILKAN PROFIL DASAR
  // =============================
  document.getElementById('user-name').innerText = userData.name || "User";
  document.getElementById('user-email').innerText = userData.email;
  document.getElementById('user-address').innerText = userData.address || "Alamat belum diatur";
  document.getElementById('user-photo').src =
    userData.photo || `https://ui-avatars.com/api/?name=${userData.email}&background=random`;

  document.getElementById('user-debt').innerText =
    (userData.debt || 0).toLocaleString();

  document.getElementById('user-role-badge').innerText =
    user.uid === ADMIN_UID ? "Admin" : "Customer";

  // =============================
  // 3. LOGIKA ROLE
  // =============================
  if (user.uid === ADMIN_UID) {

    // üî• ADMIN SAJA YANG BOLEH AMBIL SEMUA USERS
    const allUsersSnap = await getDocs(collection(db, "users"));

    let maxSpent = 0;
    allUsersSnap.forEach(uDoc => {
      maxSpent = Math.max(maxSpent, uDoc.data().totalSpent || 0);
    });

window.__maxSpent = maxSpent; 

    document.getElementById('admin-section').classList.remove('hidden');
    document.getElementById('orders-section').classList.add('hidden');
    document.getElementById('user-stats').classList.add('hidden');

    loadUsers(maxSpent);

  } else {

  // üë§ PELANGGAN
  document.getElementById('admin-section').classList.add('hidden');
  document.getElementById('orders-section').classList.remove('hidden');
  document.getElementById('user-stats').classList.remove('hidden');

  // üë§ PELANGGAN
const maxSpent = userData.totalSpent || 0;

  const mySpent = userData.totalSpent || 0;
const orderCount = userData.orderCount || 0;
let loyaltyLabel = "Pelanggan Baru üå±";

if (orderCount >= 20) loyaltyLabel = "Pelanggan Emas üèÜ";
else if (orderCount >= 10) loyaltyLabel = "Pelanggan Setia ‚≠ê";
else if (orderCount >= 5) loyaltyLabel = "Pelanggan Aktif üëç";
  const percent = maxSpent > 0
    ? Math.round((mySpent / maxSpent) * 100)
    : 0;

  document.getElementById("user-freq").innerText = percent + "%";

document.getElementById("order-count").innerText =
  `${orderCount} kali transaksi`;

document.getElementById("loyalty-label").innerText = loyaltyLabel;

  loadMyOrders(user.uid);
}

  lucide.createIcons();
});

function formatCountdown(ms) {
    const totalSec = Math.max(0, Math.floor(ms / 1000));
    const min = Math.floor(totalSec / 60);
    const sec = totalSec % 60;
    return `${min}:${sec.toString().padStart(2, '0')}`;
}

function loadMyOrders(uid) {
    const list = document.getElementById("my-orders");
    
    const q = query(
        collection(db, "orders"), 
        where("userId", "==", uid), 
    );

    onSnapshot(q, (snap) => {
console.log("Data diterima dari Firestore:", snap.size, "dokumen ditemukan");
        Object.values(activeTimers).forEach(clearInterval);
        activeTimers = {};

        if (snap.empty) {
            list.innerHTML = `<p class="text-slate-500 text-sm">Belum ada pesanan</p>`;
            return;
        }

        list.innerHTML = "";
        
        // Cek apakah panel kontrol hapus sedang terbuka
        const isDeleteMode = !document.getElementById('delete-controls').classList.contains('hidden');

        snap.forEach(docSnap => {
            const o = docSnap.data();
            const id = docSnap.id;
            const now = Date.now();
            const remainingMs = o.cancelableUntil ? o.cancelableUntil - now : 0;
            
            // Aturan: Hanya boleh hapus jika SELESAI atau DIBATALKAN
            const canBeDeleted = o.status === "SELESAI" || o.status === "DIBATALKAN";
            const isSelected = selectedOrders.includes(id);

            const card = document.createElement("div");
            // Ganti border jika dipilih
            card.className = `bg-slate-950/50 p-4 rounded-2xl border ${isSelected ? 'border-rose-500 bg-rose-500/5' : 'border-slate-800'} mb-3 relative transition-all`;

            card.innerHTML = `
                ${isDeleteMode && canBeDeleted ? `
                    <div class="absolute top-4 right-4 z-10">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                            onchange="toggleOrderSelection('${id}')" 
                            class="w-5 h-5 rounded-lg border-slate-700 bg-slate-800 text-rose-500 focus:ring-rose-500 transition-transform active:scale-90">
                    </div>
                ` : ''}

                <div class="flex justify-between mb-2">
                    <span class="text-xs font-bold ${o.status === 'DIBATALKAN' ? 'text-rose-400' : 'text-emerald-400'}">${o.status}</span>
                    <span class="text-xs text-slate-500">Rp ${(o.total || 0).toLocaleString()}</span>
                </div>
                <ul class="text-xs text-slate-400 mb-3">
                    ${(o.items || []).map(i => `<li>${i.qty}x ${i.name}</li>`).join("")}
                </ul>
                
                ${o.status === "MENUNGGU" && remainingMs > 0 ? `
                    <div class="flex items-center justify-between text-[10px] text-amber-400 mb-2">
                        <span>‚è± Bisa dibatalkan dalam <span id="timer-${id}" class="font-bold">${formatCountdown(remainingMs)}</span></span>
                    </div>
                    <button onclick="cancelOrder('${id}')" class="w-full py-2 bg-rose-500/10 text-rose-500 border border-rose-500/20 rounded-xl text-xs font-bold hover:bg-rose-500 hover:text-white transition-all">
                        Batalkan Pesanan
                    </button>
                ` : `
                    <p class="text-[10px] text-slate-500 text-center py-2 bg-slate-900/50 rounded-lg">
                        ${o.status === "DIBATALKAN" ? "Pesanan telah dibatalkan" : (o.status === "SELESAI" ? "Pesanan Diterima" : "Pesanan sedang diproses")}
                    </p>
                `}
            `;
            list.appendChild(card);

            // Logika Timer tetap sama
            if (o.status === "MENUNGGU" && remainingMs > 0) {
                activeTimers[id] = setInterval(() => {
                    const currentNow = Date.now();
                    const newRemaining = o.cancelableUntil - currentNow;
                    const timerEl = document.getElementById(`timer-${id}`);
                    if (newRemaining <= 0) {
                        clearInterval(activeTimers[id]);
                        if (timerEl) timerEl.innerText = "0:00";
                    } else {
                        if (timerEl) timerEl.innerText = formatCountdown(newRemaining);
                    }
                }, 1000);
            }
        });
        lucide.createIcons();
    
}, (error) => { // <--- TAMBAHKAN MULAI DARI SINI
    console.error("Error Query Pesanan:", error);
    const list = document.getElementById("my-orders");
    if (list) {
        list.innerHTML = `
            <div class="p-4 bg-rose-500/10 border border-rose-500/20 rounded-2xl text-center">
                <p class="text-rose-400 text-xs font-bold">Gagal memuat data</p>
                <p class="text-[10px] text-slate-500 mt-1">${error.message}</p>
            </div>
        `;
    }
}); // <--- PENUTUP ONSNAPSHOT
}

window.loadUsers = (maxSpent) => {
  const listEl = document.getElementById('users-list');

  // 1. Tentukan Query
  const q = currentSort === "spent"
    ? query(collection(db, "users"), orderBy("totalSpent", "desc"))
    : query(collection(db, "users"), orderBy("debt", "desc"));

  // 2. Gunakan onSnapshot (Try-Catch biasanya di dalam callback atau membungkus inisialisasi)
  onSnapshot(q, (snap) => {
    try {
      listEl.innerHTML = "";

      snap.forEach(userDoc => {
        if (userDoc.id === ADMIN_UID) return;

        const u = userDoc.data();
        const score = maxSpent > 0
          ? Math.round((u.totalSpent || 0) / maxSpent * 100)
          : 0;

        const card = document.createElement('div');
        card.className = "bg-slate-900/50 p-4 rounded-2xl border border-slate-800 flex items-center gap-4";
        card.innerHTML = `
            <img src="${u.photo || 'https://ui-avatars.com/api/?name=' + u.email}" class="w-12 h-12 rounded-xl object-cover bg-slate-800">
            <div class="flex-1">
                <h4 class="text-sm font-bold text-slate-100">${u.name || (u.email ? u.email.split('@')[0] : 'User')}</h4>
                <div class="flex gap-3 mt-1">
                    <span class="text-[10px] text-emerald-400 font-bold"><i data-lucide="star" class="w-3 h-3 inline"></i> ${score}%</span>
                    <span class="text-[10px] text-rose-400 font-bold"><i data-lucide="banknote" class="w-3 h-3 inline"></i> Rp ${(u.debt || 0).toLocaleString()}</span>
                </div>
            </div>
            <button onclick="openEditModal('${userDoc.id}', '${u.name || ''}', ${u.totalSpent || 0}, ${u.debt || 0})" class="p-3 bg-slate-800 text-slate-400 rounded-xl">
    <i data-lucide="edit-3" class="w-4 h-4"></i>
</button>
        `;
        listEl.appendChild(card);
      });

      lucide.createIcons();
    } catch (err) {
      console.error("Error rendering users:", err);
    }
  }, (error) => {
    console.error("Firebase Snapshot error:", error);
  });
};


window.openEditModal = (uid, name, totalSpent, debt) => {
    targetEditUid = uid;
    // Set nilai input nama
    document.getElementById('edit-name').value = name || ""; 
    document.getElementById('edit-freq').value = totalSpent;
    document.getElementById('edit-debt').value = debt;
    document.getElementById('edit-modal').classList.remove('hidden');
};

window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

window.saveUserEdit = async () => {
    const newName = document.getElementById('edit-name').value; // Ambil nilai nama baru
    const totalSpent = parseInt(document.getElementById('edit-freq').value) || 0;
    const debt = parseInt(document.getElementById('edit-debt').value) || 0;

    if (!newName.trim()) {
        alert("Nama tidak boleh kosong!");
        return;
    }

    try {
        await updateDoc(doc(db, "users", targetEditUid), { 
            name: newName, // Simpan perubahan nama ke Firestore
            totalSpent: totalSpent, 
            debt: debt 
        });
        closeEditModal();
        // Anda bisa mematikan location.reload() jika onSnapshot sudah berjalan lancar
        location.reload(); 
    } catch (err) { 
        alert("Gagal menyimpan: " + err.message); 
    }
};

window.cancelOrder = async (orderId) => {
    if (!confirm("Batalkan pesanan ini?")) return;
    try {
        await updateDoc(doc(db, "orders", orderId), { status: "DIBATALKAN" });
    } catch (err) { alert("Gagal: " + err.message); }
};

window.handleLogout = async () => {
    if (confirm("Keluar dari akun?")) {
        await signOut(auth);
        window.location.href = "login.html";
    }
};

lucide.createIcons();
    </script>
</body>
</html>















