<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - Pasar Segar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen pb-20">

    <!-- Navigasi -->
    <nav class="p-4 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
        <div class="flex items-center gap-3">
            <a href="index.html" class="p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </a>
            <h1 class="text-xl font-bold bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">Profil Saya</h1>
        </div>
        <div class="flex items-center gap-2">
    <!-- LEADERBOARD -->
    <a href="leaderboard.html"
       class="p-2 bg-yellow-500/10 text-yellow-400 rounded-xl border border-yellow-500/20"
       title="Leaderboard Pelanggan">
        <i data-lucide="crown" class="w-6 h-6"></i>
    </a>

    <!-- LOGOUT -->
    <button onclick="handleLogout()"
        class="p-2 bg-rose-500/10 text-rose-500 rounded-xl border border-rose-500/20">
        <i data-lucide="log-out" class="w-6 h-6"></i>
    </button>
</div>
    </nav>

    <main class="p-4 max-w-2xl mx-auto space-y-6">

        <!-- ================= PROFIL USER ================= -->
        <div class="bg-slate-900 rounded-[2rem] p-6 border border-slate-800 relative overflow-hidden">
            <div class="flex items-center gap-5 relative z-10">
                <div class="relative">
                    <img id="user-photo" src="https://ui-avatars.com/api/?name=User&background=random" class="w-20 h-20 rounded-2xl object-cover border-2 border-slate-800 shadow-2xl">
                    <div id="user-role-badge" class="absolute -bottom-2 -right-2 bg-emerald-500 text-slate-950 text-[10px] font-bold px-2 py-1 rounded-lg uppercase border-2 border-slate-900">Customer</div>
                </div>
                <div>
                    <h2 id="user-name" class="text-xl font-bold text-white mb-1">Memuat...</h2>
                    <p id="user-email" class="text-xs text-slate-500 mb-2">email@contoh.com</p>
                    <span class="text-[10px] bg-slate-800 text-slate-400 px-2 py-1 rounded-md border border-slate-700">
                        <i data-lucide="map-pin" class="w-3 h-3 inline mr-1"></i>
                        <span id="user-address">Alamat belum diatur</span>
                    </span>
                </div>
            </div>

            <div id="user-stats" class="grid grid-cols-2 gap-3 mt-8">
                <div class="bg-slate-950/50 p-4 rounded-2xl border border-slate-800/50">
  <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">
    Frekuensi Transaksi
  </p>
  <p class="text-lg font-bold text-emerald-400">
    <span id="user-freq">0%</span>
  </p>
</div>
<div class="bg-slate-950/50 p-4 rounded-2xl border border-slate-800/50">
  <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">
    Total Transaksi
  </p>
  <p class="text-lg font-bold text-cyan-400">
    <span id="order-count">0 kali transaksi</span>
  </p>
  <p class="text-[10px] text-slate-400 mt-1" id="loyalty-label">
    Pelanggan Baru üå±
  </p>
</div>
                <div class="bg-slate-950/50 p-4 rounded-2xl border border-slate-800/50">
                    <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Catatan Hutang</p>
                    <p class="text-lg font-bold text-rose-400">Rp <span id="user-debt">0</span></p>
                </div>
            </div>
        </div>

        <!-- ================= PESANAN SAYA ================= -->
        <section id="orders-section" class="bg-slate-900 rounded-[2rem] p-5 border border-slate-800">
 <div class="flex justify-between items-center mb-3">
            <h3 class="text-lg font-bold text-white mb-3">Pesanan Saya</h3>
 <button onclick="toggleSelectMode()" class="text-[10px] font-bold text-amber-400 bg-amber-400/10 px-3 py-1.5 rounded-lg border border-amber-400/20">
    Kelola Sembunyikan
</button>
    </div>
<div id="delete-controls" class="hidden flex justify-between items-center mb-3 bg-slate-800/50 p-3 rounded-2xl border border-slate-700">
        <button onclick="hideSelectedOrders()" class="text-xs font-bold text-amber-500 bg-amber-500/20 px-4 py-2 rounded-xl border border-amber-500/30">
    Sembunyikan Terpilih (<span id="selected-count">0</span>)
</button>
        <button onclick="toggleSelectMode()" class="text-xs text-slate-400 font-bold">Batal</button>
    </div>

            <div id="my-orders" class="space-y-3 max-h-[60vh] overflow-y-auto hide-scrollbar pr-1">
                <p class="text-slate-500 text-sm">Memuat pesanan...</p>
            </div>
        </section>

        <!-- ================= ADMIN SECTION ================= -->
        <div id="admin-section" class="hidden space-y-4">
            <h3 class="text-lg font-bold text-white">Daftar Pelanggan</h3>
<div class="relative mt-2 mb-4">
    <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
    <input type="text" id="search-customer" oninput="filterCustomers()" placeholder="Cari nama pelanggan..." 
    class="w-full bg-slate-900 border border-slate-800 rounded-2xl py-3 pl-11 pr-4 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
</div>
<div class="flex gap-3 mb-4">
<button
  onclick="resetAllTotalSpent()"
  class="flex-1 py-3 bg-red-600/10 text-red-500 rounded-xl text-xs font-bold border border-red-500/30">
  ‚ö† Reset % Belanja
</button>

  <button
  onclick="toggleSort(this)" 
  class="flex-1 py-3 bg-slate-800 rounded-xl text-xs font-bold transition-all active:scale-95">
  üîÅ Urutkan (Belanja)
</button>

  <button
    onclick="resetAllFrequency()"
    class="flex-1 py-3 bg-rose-500/10 text-rose-500 rounded-xl text-xs font-bold border border-rose-500/20">
    ‚ôª Reset Transaksi
  </button>
</div>

<div id="users-list" class="space-y-3"></div>
        </div>

    </main>

    <!-- Modal Edit Admin -->
    <div id="edit-modal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-slate-900 w-full max-w-sm rounded-[2.5rem] p-8 border border-slate-800 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-6">Edit Data Pelanggan</h3>
            <div class="space-y-5">
                <div>
 <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2">Nama Pelanggan</label>
                <input type="text" id="edit-name" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-blue-500 text-white">
            </div>
                <div>
                    <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2">Catatan Hutang (Rp)</label>
                    <input type="number" id="edit-debt" class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-rose-500">
                </div>
<div>
  <label class="block text-[10px] text-slate-500 uppercase font-bold mb-2">
    Loyalty Label
  </label>
  <input type="text"
    id="edit-loyalty"
    placeholder="Contoh: Pelanggan VIP üíé"
    class="w-full bg-slate-950 border border-slate-800 rounded-2xl p-4 text-sm outline-none focus:ring-2 focus:ring-yellow-500">
</div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeEditModal()" class="flex-1 py-4 bg-slate-800 rounded-2xl font-bold text-sm">Batal</button>
                    <button onclick="saveUserEdit()" class="flex-1 py-4 bg-emerald-500 text-slate-950 rounded-2xl font-bold text-sm shadow-lg shadow-emerald-500/20">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Ganti seluruh isi tag <script type="module"> pada profile.html dengan kode ini:

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, collection, updateDoc, query, orderBy, where, onSnapshot, increment, arrayUnion, limit, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";


const firebaseConfig = {
    apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
    authDomain: "sayurjuju-bfe82.firebaseapp.com",
    projectId: "sayurjuju-bfe82",
    storageBucket: "sayurjuju-bfe82.firebasestorage.app",
    messagingSenderId: "754413439458",
    appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);



const ADMIN_UID = "XVmdoXxSptTlA8xHVmAIzeLgkru2";
let unsubscribeUsers = null;
let currentSort = "spent"; // spent | debt
let targetEditUid = null;
let activeTimers = {};
let pinnedUsers = {}; 
// contoh: { uid1: true, uid2: true }

// ===== STATE TRANSAKSI OFFLINE =====
let offlineTargetUid = null;
let offlineSelected = {};
// Tambahkan fungsi pendukung di dalam tag <script>
let selectedOrders = [];

window.toggleSelectMode = () => {
    selectedOrders = [];
    document.getElementById('delete-controls').classList.toggle('hidden');
    
    // Ambil UID user yang sedang login untuk memuat ulang list
    const user = auth.currentUser;
    if (user) loadMyOrders(user.uid); 
};


window.toggleOrderSelection = (id) => {
    const index = selectedOrders.indexOf(id);
    if (index > -1) {
        selectedOrders.splice(index, 1);
    } else {
        selectedOrders.push(id);
    }
    document.getElementById('selected-count').innerText = selectedOrders.length;
    
    // Opsional: Beri border merah pada kartu yang dipilih secara manual tanpa reload
    const user = auth.currentUser;
    if (user) loadMyOrders(user.uid); 
};


window.hideSelectedOrders = async () => {
  const user = auth.currentUser;
  if (!user) return;

  if (!confirm(`Sembunyikan ${selectedOrders.length} pesanan?`)) return;

  for (const id of selectedOrders) {
    const ref = doc(db, "orders", id);
    await updateDoc(ref, {
      hiddenFor: arrayUnion(user.uid)
    });
  }

  selectedOrders = [];
  document.getElementById('delete-controls').classList.add('hidden');
};


window.toggleSort = (btn) => {
  if (currentSort === "spent") {
    currentSort = "debt";
    btn.innerText = "üîÅ Urutkan (Hutang)";
  } else if (currentSort === "debt") {
    currentSort = "transaction";
    btn.innerText = "üîÅ Urutkan (Transaksi)";
  } else {
    currentSort = "spent";
    btn.innerText = "üîÅ Urutkan (Belanja)";
  }

  loadUsers(window.__maxSpent || 0);
};


window.resetAllFrequency = async () => {
  if (!confirm("Reset semua frekuensi belanja ke 0% ?")) return;

  try {
    const snap = await getDocs(collection(db, "users"));

    const batchUpdates = [];

    snap.forEach(docSnap => {
      if (docSnap.id !== ADMIN_UID) {
        batchUpdates.push(
          updateDoc(doc(db, "users", docSnap.id), {
    offlineOrderCount: 0, 
    orderCount: 0,
    totalTransaction: 0 
})
        );
      }
    });

    await Promise.all(batchUpdates);

// üîî NOTIFIKASI KE CUSTOMER (ANDROID SAJA)
    sendAndroidNotif(
      "reset",
      "Riwayat Transaksi Direset",
      "Admin telah mengatur ulang total transaksi kamu ke 0"
    );

    alert("Semua frekuensi berhasil di-reset");
    location.reload();
  } catch (err) {
    alert(err.message);
  }
};

function sendAndroidNotif(type, title, body) {
  if (window.Android && typeof Android.notify === "function") {
    Android.notify(type, title, body);
  }
}

window.resetAllTotalSpent = async () => {
  const confirmText = prompt(
    'Ketik "RESET" untuk mengatur ulang TOTAL BELANJA semua customer'
  );

  if (confirmText !== "RESET") {
    alert("Dibatalkan. Teks tidak sesuai.");
    return;
  }

  try {
    const snap = await getDocs(collection(db, "users"));
    const updates = [];

    snap.forEach(u => {
      if (u.id !== ADMIN_UID) {
        updates.push(
          updateDoc(doc(db, "users", u.id), {
            totalSpent: 0
          })
        );
      }
    });

    await Promise.all(updates);
    alert("Semua total belanja customer berhasil di-reset.");
    location.reload();
  } catch (err) {
    alert("Gagal reset: " + err.message);
  }
};



window.addOffline = (uid) => {
  openOfflineModal(uid);
};

window.removeOffline = async (uid) => {
  if (!confirm("Kurangi 1 transaksi offline?")) return;

  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) return;

  const current = snap.data().offlineOrderCount || 0;

  if (current <= 0) {
    alert("Frekuensi offline sudah 0");
    return;
  }

  await updateDoc(ref, {
    offlineOrderCount: increment(-1)
  });

  alert("Transaksi offline dikurangi");
};

// Tambahkan ini di bagian script profile.html Anda
const CART_KEY = "pasar_cart";
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];


onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // =============================
  // 1. AMBIL DATA USER SENDIRI
  // =============================
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    console.error("User document belum ada");
    return;
  }

  const userData = userSnap.data();

  // =============================
  // 2. TAMPILKAN PROFIL DASAR
  // =============================
  document.getElementById('user-name').innerText = userData.name || "User";
  document.getElementById('user-email').innerText = userData.email;
  document.getElementById('user-address').innerText = userData.address || "Alamat belum diatur";
  document.getElementById('user-photo').src =
    userData.photo || `https://ui-avatars.com/api/?name=${userData.email}&background=random`;

  document.getElementById('user-debt').innerText =
    (userData.debt || 0).toLocaleString();

  document.getElementById('user-role-badge').innerText =
    user.uid === ADMIN_UID ? "Admin" : "Customer";

  // =============================
  // 3. LOGIKA ROLE
  // =============================
  if (user.uid === ADMIN_UID) {

    // üî• ADMIN SAJA YANG BOLEH AMBIL SEMUA USERS
    const allUsersSnap = await getDocs(collection(db, "users"));

    let maxSpent = 0;
    allUsersSnap.forEach(uDoc => {
      maxSpent = Math.max(maxSpent, uDoc.data().totalSpent || 0);
    });

window.__maxSpent = maxSpent; 

    document.getElementById('admin-section').classList.remove('hidden');
    document.getElementById('orders-section').classList.add('hidden');
    document.getElementById('user-stats').classList.add('hidden');

    loadUsers(maxSpent);

  } else {

  // üë§ PELANGGAN
  document.getElementById('admin-section').classList.add('hidden');
  document.getElementById('orders-section').classList.remove('hidden');
  document.getElementById('user-stats').classList.remove('hidden');

  // üë§ PELANGGAN
// Ambil maxSpent global (1 dokumen saja, ringan)
const maxSnap = await getDocs(
  query(collection(db, "users"), orderBy("totalSpent", "desc"), limit(1))
);

const maxSpent = maxSnap.empty
  ? 0
  : maxSnap.docs[0].data().totalSpent || 0;

const mySpent = userData.totalSpent || 0;
const online = userData.orderCount || 0;
const offline = userData.offlineOrderCount || 0;
const orderCount = online + offline;
let loyaltyLabel =
  userData.loyaltyLabel ||
  "Pelanggan Baru üå±";

if (orderCount >= 20) loyaltyLabel = "Pelanggan Emas üèÜ";
else if (orderCount >= 10) loyaltyLabel = "Pelanggan Setia ‚≠ê";
else if (orderCount >= 5) loyaltyLabel = "Pelanggan Aktif üëç";
  const percent = maxSpent > 0
  ? Math.round((mySpent / maxSpent) * 100)
  : 0;

document.getElementById("user-freq").innerText = percent + "%";

document.getElementById("order-count").innerText =
  `${orderCount} kali transaksi`;

document.getElementById("loyalty-label").innerText = loyaltyLabel;

  loadMyOrders(user.uid);
}

  lucide.createIcons();
});

function formatCountdown(ms) {
    const totalSec = Math.max(0, Math.floor(ms / 1000));
    const min = Math.floor(totalSec / 60);
    const sec = totalSec % 60;
    return `${min}:${sec.toString().padStart(2, '0')}`;
}

function loadMyOrders(uid) {
    const list = document.getElementById("my-orders");
    
    const q = query(
    collection(db, "orders"),
    where("userId", "==", uid),
    orderBy("createdAt", "desc")
);

    if (unsubscribeUsers) {
  unsubscribeUsers();
}

unsubscribeUsers = onSnapshot(
  q,
  (snap) => {
const container = document.getElementById("my-orders");
console.log("Data diterima dari Firestore:", snap.size, "dokumen ditemukan");
        Object.values(activeTimers).forEach(clearInterval);
        activeTimers = {};

        if (snap.empty) {
            list.innerHTML = `<p class="text-slate-500 text-sm">Belum ada pesanan</p>`;
            return;
        }

        list.innerHTML = "";
        
        // Cek apakah panel kontrol hapus sedang terbuka
        const isHideMode = !document.getElementById('delete-controls').classList.contains('hidden');
const isDeleteMode = isHideMode;

        snap.forEach(docSnap => {
            const o = docSnap.data();
            const id = docSnap.id;
const hidden = o.hiddenFor || [];
if (hidden.includes(uid)) return;
            const now = Date.now();
            const remainingMs = o.cancelableUntil ? o.cancelableUntil - now : 0;
            
            // Aturan: Hanya boleh hapus jika SELESAI atau DIBATALKAN
            const canBeDeleted = o.status === "SELESAI" || o.status === "DIBATALKAN";
            const isSelected = selectedOrders.includes(id);

            const card = document.createElement("div");
            // Ganti border jika dipilih
            card.className = `bg-slate-950/50 p-4 rounded-2xl border ${isSelected ? 'border-rose-500 bg-rose-500/5' : 'border-slate-800'} mb-3 relative transition-all`;

            card.innerHTML = `
                ${isDeleteMode && canBeDeleted ? `
                    <div class="absolute top-4 right-4 z-10">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                            onchange="toggleOrderSelection('${id}')" 
                            class="w-5 h-5 rounded-lg border-slate-700 bg-slate-800 text-rose-500 focus:ring-rose-500 transition-transform active:scale-90">
                    </div>
                ` : ''}

                <div class="flex justify-between mb-2">
                    <span class="text-xs font-bold ${o.status === 'DIBATALKAN' ? 'text-rose-400' : 'text-emerald-400'}">${o.status}</span>
                    <span class="text-xs text-slate-500">Rp ${(o.total || 0).toLocaleString()}</span>
                </div>
                <ul class="text-xs text-slate-400 mb-3">
                    ${(o.items || []).map(i => `<li>${i.qty}x ${i.name}</li>`).join("")}
                </ul>
                
                ${o.status === "MENUNGGU" && remainingMs > 0 ? `
                    <div class="flex items-center justify-between text-[10px] text-amber-400 mb-2">
                        <span>‚è± Bisa dibatalkan dalam <span id="timer-${id}" class="font-bold">${formatCountdown(remainingMs)}</span></span>
                    </div>
                    <button onclick="cancelOrder('${id}')" class="w-full py-2 bg-rose-500/10 text-rose-500 border border-rose-500/20 rounded-xl text-xs font-bold hover:bg-rose-500 hover:text-white transition-all">
                        Batalkan Pesanan
                    </button>
                ` : `
                    <p class="text-[10px] text-slate-500 text-center py-2 bg-slate-900/50 rounded-lg">
                        ${o.status === "DIBATALKAN" ? "Pesanan telah dibatalkan" : (o.status === "SELESAI" ? "Pesanan Diterima" : "Pesanan sedang diproses")}
                    </p>
                `}
            `;
            list.appendChild(card);

            // Logika Timer tetap sama
            if (o.status === "MENUNGGU" && remainingMs > 0) {
                activeTimers[id] = setInterval(() => {
                    const currentNow = Date.now();
                    const newRemaining = o.cancelableUntil - currentNow;
                    const timerEl = document.getElementById(`timer-${id}`);
                    if (newRemaining <= 0) {
                        clearInterval(activeTimers[id]);
                        if (timerEl) timerEl.innerText = "0:00";
                    } else {
                        if (timerEl) timerEl.innerText = formatCountdown(newRemaining);
                    }
                }, 1000);
            }
        });
        lucide.createIcons();
    
}, (error) => { // <--- TAMBAHKAN MULAI DARI SINI
    console.error("Error Query Pesanan:", error);
    const list = document.getElementById("my-orders");
    if (list) {
        list.innerHTML = `
            <div class="p-4 bg-rose-500/10 border border-rose-500/20 rounded-2xl text-center">
                <p class="text-rose-400 text-xs font-bold">Gagal memuat data</p>
                <p class="text-[10px] text-slate-500 mt-1">${error.message}</p>
            </div>
        `;
    }
}); // <--- PENUTUP ONSNAPSHOT
}

window.loadUsers = (maxSpent) => {
  const listEl = document.getElementById('users-list');

  let q;

if (currentSort === "spent") {
  q = query(collection(db, "users"), orderBy("totalSpent", "desc"));
} else if (currentSort === "debt") {
  q = query(collection(db, "users"), orderBy("debt", "desc"));
} else {
  // ambil semua user, sorting nanti di JS
  q = query(collection(db, "users"));
}

  // 2. Gunakan onSnapshot (Try-Catch biasanya di dalam callback atau membungkus inisialisasi)
  if (unsubscribeUsers) {
  unsubscribeUsers();
}

unsubscribeUsers = onSnapshot(
  q,
  (snap) => {
    listEl.innerHTML = "";

let users = [];

snap.forEach(docSnap => {
  if (docSnap.id === ADMIN_UID) return;

  const data = docSnap.data();

  users.push({
    id: docSnap.id,
    ...data,
    totalTx: (data.orderCount || 0) + (data.offlineOrderCount || 0)
  });
});

// SORT JIKA MODE TRANSAKSI
if (currentSort === "transaction") {
  users.sort((a, b) => b.totalTx - a.totalTx);
}

// RENDER PAKAI users (BUKAN snap.forEach)
users.forEach(u => {

  const score = maxSpent > 0
    ? Math.round((u.totalSpent || 0) / maxSpent * 100)
    : 0;

  const online = u.orderCount || 0;
const offline = u.offlineOrderCount || 0;
const totalTx = online + offline;

  const card = document.createElement('div');
card.className =
  "user-card bg-slate-900/50 p-4 rounded-2xl border border-slate-800 flex items-center gap-4";

  card.innerHTML = `
    <img src="${u.photo || 'https://ui-avatars.com/api/?name=' + u.email}"
         class="w-12 h-12 rounded-xl object-cover bg-slate-800">

    <div class="flex-1">
      <h4 class="text-sm font-bold text-slate-100">
        ${u.name || (u.email ? u.email.split('@')[0] : 'User')}
      </h4>

      <span class="text-[10px] text-cyan-400 font-bold">
        üîÑ ${totalTx} transaksi
      </span>

      <div class="flex gap-3 mt-1">
        <span class="text-[10px] text-emerald-400 font-bold">
          <i data-lucide="star" class="w-3 h-3 inline"></i> ${score}%
        </span>
        <span class="text-[10px] text-rose-400 font-bold">
          <i data-lucide="banknote" class="w-3 h-3 inline"></i>
          Rp ${(u.debt || 0).toLocaleString()}
        </span>
      </div>
    </div>

    <div class="flex gap-1">
      <button
        onclick="openOfflineModal('${u.id}')"
        class="px-3 py-1 text-[10px] font-bold rounded-lg bg-emerald-500">
        +1
      </button>

      <button
        onclick="removeOffline('${u.id}')"
        class="px-3 py-1 text-[10px] font-bold rounded-lg bg-rose-500 text-white">
        -1
      </button>
    </div>

    <button onclick="openEditModal(
      '${u.id}',
      '${u.name || ""}',
      ${u.totalSpent || 0},
      ${u.debt || 0},
      '${u.loyaltyLabel || ""}'
    )">
      <i data-lucide="edit-3" class="w-4 h-4"></i>
    </button>
  `;

  listEl.appendChild(card);
});

    lucide.createIcons();
  },
  (error) => {
    alert(error.message);   // untuk munculin link Create Index
    console.error(error);
  }
);
}; // ‚¨ÖÔ∏è PENUTUP window.loadUsers

window.openOfflineModal = async (uid) => {
  offlineTargetUid = uid;
  offlineSelected = {};

  const listEl = document.getElementById("offline-product-list");
  listEl.innerHTML = "Memuat produk...";
  // Tambahkan ini agar kolom search kosong saat modal dibuka kembali
  if(document.getElementById('search-product-offline')) {
      document.getElementById('search-product-offline').value = '';
  }


  const snap = await getDocs(collection(db, "products"));

  listEl.innerHTML = "";

  snap.forEach(docSnap => {
    const p = docSnap.data();
    if (p.stock <= 0) return;

    const row = document.createElement("div");
row.className = "flex items-center justify-between bg-slate-800 p-3 rounded-xl";
row.dataset.productId = docSnap.id;

    row.innerHTML = `
      <label class="flex items-center gap-3 text-sm">
        <input type="checkbox"
          onchange="toggleOfflineProduct('${docSnap.id}', this.checked)"
          class="accent-emerald-500">
        ${p.name}
        <span class="text-[10px] text-slate-400">(stok ${p.stock})</span>
      </label>

      <input type="number" min="1" value="1"
        onchange="setOfflineQty('${docSnap.id}', this.value)"
        class="w-16 bg-slate-900 border border-slate-700 rounded-lg text-xs px-2 py-1">
    `;

    listEl.appendChild(row);
  });

  document.getElementById("offline-modal").classList.remove("hidden");
};

window.toggleOfflineProduct = (id, checked) => {
  const list = document.getElementById("offline-product-list");
  const row = list.querySelector(`[data-product-id="${id}"]`);

  if (!row) return;

  if (checked) {
  offlineSelected[id] = 1;
  row.classList.add("ring-2", "ring-emerald-500");
  list.prepend(row);
} else {
  delete offlineSelected[id];
  row.classList.remove("ring-2", "ring-emerald-500");
}
const rows = Array.from(list.children);
  rows.sort((a, b) => {
    const aChecked = offlineSelected[a.dataset.productId] ? 1 : 0;
    const bChecked = offlineSelected[b.dataset.productId] ? 1 : 0;
    return bChecked - aChecked;
  });

  rows.forEach(r => list.appendChild(r));
};

window.setOfflineQty = (id, qty) => {
  if (offlineSelected[id] !== undefined) {
    offlineSelected[id] = parseInt(qty) || 1;
  }
};

window.confirmOfflineTransaction = async () => {
  const ids = Object.keys(offlineSelected);
  if (ids.length === 0) {
    alert("Pilih minimal 1 produk");
    return;
  }

  try {
    let totalHarga = 0;
    const itemsForOrder = [];
    
    // 1. Ambil data harga produk terbaru & siapkan data item
    for (const id of ids) {
      const pSnap = await getDoc(doc(db, "products", id));
      if (pSnap.exists()) {
        const pData = pSnap.data();
        const qty = offlineSelected[id];
        const subtotal = pData.price * qty;
        totalHarga += subtotal;

        itemsForOrder.push({
          productId: id,
          name: pData.name,
          price: pData.price,
          qty: qty
        });

        // 2. Kurangi stok produk
        await updateDoc(doc(db, "products", id), {
          stock: increment(-qty)
        });
      }
    }

    // 3. Buat dokumen Order baru (Agar masuk ke rekap pendapatan Admin)
    const newOrderRef = doc(collection(db, "orders"));
    await setDoc(newOrderRef, {
      userId: offlineTargetUid,
      items: itemsForOrder,
      total: totalHarga,
      status: "SELESAI", // Langsung selesai agar masuk pendapatan
      deliveryMethod: "OFFLINE",
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    });

    // 4. Update data akumulasi User (Total belanja & Frekuensi)
    await updateDoc(doc(db, "users", offlineTargetUid), {
      offlineOrderCount: increment(1),
      totalSpent: increment(totalHarga),
      lastTransactionAt: serverTimestamp()
    });

    closeOfflineModal();
    alert(`Transaksi offline Rp ${totalHarga.toLocaleString()} berhasil dicatat!`);
  } catch (err) {
    console.error(err);
    alert("Gagal mencatat transaksi: " + err.message);
  }
};


window.closeOfflineModal = () => {
  document.getElementById("offline-modal").classList.add("hidden");
};

window.openEditModal = (uid, name, totalSpent, debt, loyalty = "") => {
  targetEditUid = uid;
  document.getElementById('edit-name').value = name || "";
  document.getElementById('edit-debt').value = debt || 0;
  document.getElementById('edit-loyalty').value = loyalty || "";
  document.getElementById('edit-modal').classList.remove('hidden');
};

window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

window.saveUserEdit = async () => {
    const newName = document.getElementById('edit-name').value; // Ambil nilai nama baru
    
    const debt = parseInt(document.getElementById('edit-debt').value) || 0;

    if (!newName.trim()) {
        alert("Nama tidak boleh kosong!");
        return;
    }

    try {
        const loyalty = document.getElementById('edit-loyalty').value;

await updateDoc(doc(db, "users", targetEditUid), {
  name: newName,
  debt: debt,
  loyaltyLabel: loyalty
});
        closeEditModal();
        // Anda bisa mematikan location.reload() jika onSnapshot sudah berjalan lancar
        location.reload(); 
    } catch (err) { 
        alert("Gagal menyimpan: " + err.message); 
    }
};

window.cancelOrder = async (orderId) => {
    if (!confirm("Batalkan pesanan ini?")) return;
    try {
        await updateDoc(doc(db, "orders", orderId), { status: "DIBATALKAN" });
    } catch (err) { alert("Gagal: " + err.message); }
};

window.handleLogout = async () => {
    if (confirm("Keluar dari akun?")) {
if (unsubscribeUsers) {
  unsubscribeUsers();
  unsubscribeUsers = null;
}
        await signOut(auth);
        window.location.href = "login.html";
    }
};

// --- Fungsi Filter Daftar Customer ---
window.filterCustomers = () => {
  const term = document
    .getElementById('search-customer')
    .value
    .toLowerCase();

  const cards = document.querySelectorAll('#users-list .user-card');

  cards.forEach(card => {
    const nameText =
      card.querySelector('h4')?.innerText.toLowerCase() || "";

    if (nameText.includes(term)) {
      card.classList.remove('hidden');
    } else {
      card.classList.add('hidden');
    }
  });
};

// --- Fungsi Filter Produk di Modal Offline ---
window.filterOfflineProducts = () => {
    const term = document.getElementById('search-product-offline').value.toLowerCase();
    const list = document.getElementById('offline-product-list');
    const items = list.children;

    Array.from(items).forEach(item => {
        const productName = item.querySelector('label')?.innerText.toLowerCase() || "";
        if (productName.includes(term)) {
            item.classList.remove('hidden');
            item.classList.add('flex');
        } else {
            item.classList.add('hidden');
            item.classList.remove('flex');
        }
    });
};

// Update pemanggilan icon agar icon search muncul
lucide.createIcons();

// Fungsi Pengawas Status Pesanan (Customer Side)
const listenToOrderStatus = (userId) => {
    const q = query(
        collection(db, "orders"),
        where("userId", "==", userId)
    );

    onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            // Kita hanya bereaksi jika data di Firestore di-MODIFIED (diubah oleh admin)
            if (change.type === "modified") {
                const orderData = change.doc.data();
                const status = orderData.status;
                
                // Keamanan: Cek apakah perubahan ini baru saja terjadi (dalam 30 detik terakhir)
                // Agar user tidak dapat notif berulang saat buka halaman
                const now = Date.now();
                const updatedAt = orderData.updatedAt ? orderData.updatedAt.toMillis() : now;
                const isRecent = (now - updatedAt) < 30000; 

                if (window.Android && isRecent) {
                    if (status === "DIANTAR") {
                        window.Android.notify(
                            "default", 
                            "Pesanan Sedang Diantar! üõµ", 
                            "Kurir kami sedang menuju lokasi Anda."
                        );
                    } 
                    else if (status === "SELESAI") {
                        window.Android.notify(
                            "default", 
                            "Terima Kasih! üéâ", 
                            "Pesanan telah diterima. Sampai belanja kembali!"
                        );
                    }
                }
            }
        });
    });
};

// Pastikan dipanggil di dalam listener auth
onAuthStateChanged(auth, (user) => {
    if (user) {
        listenToOrderStatus(user.uid);
        loadUserOrders(user.uid); // Fungsi yang sudah ada di file Anda
        loadUserData(user.uid);   // Fungsi yang sudah ada di file Anda
    }
});


    </script>
<div id="offline-modal"
 class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">

  <div class="bg-slate-900 w-full max-w-2xl rounded-[2.5rem] p-8 border border-slate-800 shadow-2xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h3 class="font-bold text-xl text-white">Catat Transaksi Offline</h3>
        <button onclick="closeOfflineModal()" class="p-2 bg-slate-800 rounded-full text-slate-400"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>

    <div class="relative mb-6">
        <i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
        <input type="text" id="search-product-offline" oninput="filterOfflineProducts()" placeholder="Cari nama produk..." 
        class="w-full bg-slate-950 border border-slate-800 rounded-2xl py-4 pl-12 pr-4 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
    </div>

    <div id="offline-product-list" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[50vh] overflow-y-auto pr-2 hide-scrollbar">
        </div>

    <div class="flex gap-3 mt-6">
      <button onclick="closeOfflineModal()"
        class="flex-1 py-3 bg-slate-800 rounded-xl font-bold text-sm">
        Batal
      </button>
      <button onclick="confirmOfflineTransaction()"
        class="flex-1 py-3 bg-emerald-500 text-slate-950 rounded-xl font-bold text-sm">
        Konfirmasi
      </button>
    </div>
  </div>
</div>
</body>
</html>
