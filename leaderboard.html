<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaderboard Pelanggan - Pasar Segar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; }
    .gold-glow { box-shadow: 0 0 20px rgba(234, 179, 8, 0.2); }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">

  <!-- NAVBAR -->
  <nav class="p-4 flex items-center gap-3 sticky top-0 bg-slate-950/90 backdrop-blur-md z-40 border-b border-slate-900">
    <a href="profile.html" class="p-2 bg-slate-900 text-slate-400 rounded-xl border border-slate-800">
      <i data-lucide="arrow-left" class="w-6 h-6"></i>
    </a>
    <h1 class="text-xl font-bold bg-gradient-to-r from-yellow-400 to-amber-500 bg-clip-text text-transparent flex items-center gap-2">
      <span>üèÜ</span> Leaderboard
    </h1>
  </nav>

  <main class="p-4 max-w-md mx-auto">
    <!-- Header Stats -->
    <div class="bg-slate-900/40 border border-slate-800 rounded-2xl p-6 mb-6 text-center">
      <p class="text-slate-400 text-sm mb-1">Pelanggan Teraktif</p>
      <h2 class="text-2xl font-bold text-white">Top Peringkat Periode</h2>
      <p class="text-[10px] text-slate-500 mt-2 uppercase tracking-widest">Berdasarkan Total Order Online + Offline</p>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center py-20 gap-4">
      <div class="w-8 h-8 border-4 border-yellow-500/20 border-t-yellow-500 rounded-full animate-spin"></div>
      <p class="text-slate-500 text-sm italic">Menghitung skor pelanggan...</p>
    </div>

    <!-- User List -->
    <div id="leaderboard-list" class="space-y-3 hidden">
      <!-- Data diisi via JS -->
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, collection, query, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWkPqyh54IRccNz2YjuB1bL5r49YadAP4",
      authDomain: "sayurjuju-bfe82.firebaseapp.com",
      projectId: "sayurjuju-bfe82",
      storageBucket: "sayurjuju-bfe82.firebasestorage.app",
      messagingSenderId: "754413439458",
      appId: "1:754413439458:web:341c9fe99fd9b1550551bb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const listEl = document.getElementById('leaderboard-list');
    const loadingEl = document.getElementById('loading');

    // PROTEKSI & INISIALISASI
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // Jika tidak login, coba sign in anonim (opsional) atau lempar ke login
        window.location.href = 'login.html';
      } else {
        initLeaderboard();
      }
    });

    function initLeaderboard() {
      // Step 1: Query dasar (Tanpa orderBy Firestore agar bisa custom sort di JS)
      const q = query(collection(db, 'users'), limit(100));

      onSnapshot(q, (snap) => {
        if (snap.empty) {
          loadingEl.classList.add('hidden');
          listEl.classList.remove('hidden');
          listEl.innerHTML = `
            <div class="text-center py-10 text-slate-500">
              <p>Belum ada data pelanggan.</p>
            </div>
          `;
          return;
        }

        const usersData = [];

        // Step 2: Hitung Skor Hadiah (Online + Offline)
        snap.forEach(docSnap => {
          const data = docSnap.data();
          const online = data.orderCount || 0;
          const offline = data.offlineOrderCount || 0;
          const totalScore = online + offline;

          // Hanya masukkan yang punya transaksi
          if (totalScore > 0) {
            usersData.push({
              uid: docSnap.id,
              name: data.name || 'Pelanggan',
              photo: data.photo || null,
              online: online,
              offline: offline,
              scoreHadiah: totalScore
            });
          }
        });

        // Step 3: Sorting Manual (Terbesar ke Terkecil)
        usersData.sort((a, b) => b.scoreHadiah - a.scoreHadiah);

        // Step 4: Render ke UI
        renderLeaderboard(usersData.slice(0, 50)); // Ambil top 50 saja untuk performa
      }, (error) => {
        console.error("Firestore Error:", error);
        loadingEl.innerHTML = `<p class="text-red-400 text-sm">Gagal memuat data peringkat.</p>`;
      });
    }

    function renderLeaderboard(users) {
      loadingEl.classList.add('hidden');
      listEl.classList.remove('hidden');
      listEl.innerHTML = '';

      users.forEach((u, index) => {
        const rank = index + 1;
        const isTop1 = rank === 1;
        const isTop2 = rank === 2;
        const isTop3 = rank === 3;

        let badgeIcon = `#${rank}`;
        let badgeColor = 'text-slate-500';
        
        if(isTop1) { badgeIcon = 'ü•á'; badgeColor = 'text-yellow-400'; }
        if(isTop2) { badgeIcon = 'ü•à'; badgeColor = 'text-slate-300'; }
        if(isTop3) { badgeIcon = 'ü•â'; badgeColor = 'text-amber-600'; }

        const card = document.createElement('div');
        card.className = `flex items-center gap-4 p-4 rounded-2xl border transition-all ${
          isTop1 ? 'bg-yellow-500/10 border-yellow-500/30 gold-glow' : 'bg-slate-900/60 border-slate-800'
        }`;

        card.innerHTML = `
          <div class="w-8 text-center font-bold text-lg ${badgeColor}">${badgeIcon}</div>
          <div class="relative">
              <img src="${u.photo || 'https://ui-avatars.com/api/?background=1e293b&color=fff&name=' + encodeURIComponent(u.name)}" 
                   class="w-12 h-12 rounded-xl object-cover border-2 ${isTop1 ? 'border-yellow-500' : 'border-slate-700'}" />
              ${isTop1 ? '<span class="absolute -top-2 -right-2 text-lg">üëë</span>' : ''}
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-bold text-slate-100 truncate">${u.name}</p>
            <p class="text-xs text-slate-400 font-semibold">${u.scoreHadiah} Poin Transaksi</p>
          </div>
          <div class="text-right">
              <div class="text-[10px] font-bold text-blue-400 uppercase">${u.online} Online</div>
              <div class="text-[10px] font-medium text-slate-500 uppercase">${u.offline} Offline</div>
          </div>
        `;
        
        listEl.appendChild(card);
      });

      // Refresh icons if any used via data-lucide
      lucide.createIcons();
    }

    lucide.createIcons();
  </script>
</body>
</html>


